# LiveInsight 테스트 가이드

## 📋 테스트 개요

LiveInsight 시스템의 모든 구성 요소를 검증하기 위한 테스트 가이드입니다.

## 🧪 자동 테스트 실행

### 전체 테스트
```bash
# 모든 테스트 실행
./scripts/run-tests.sh

# 배포 검증 테스트
./scripts/test.sh deployment
```

### 개별 테스트
```bash
# 통합 테스트
./scripts/run-tests.sh integration

# 성능 테스트
./scripts/run-tests.sh performance

# E2E 테스트
./scripts/run-tests.sh e2e
```

## 🔍 수동 검증

### 1. 인프라 상태 확인
```bash
# DynamoDB 테이블 확인
aws dynamodb list-tables --query 'TableNames[?contains(@, `LiveInsight`)]'

# Lambda 함수 확인
aws lambda get-function --function-name LiveInsight-EventCollector

# ECS 서비스 확인
aws ecs describe-services --cluster LiveInsight-cluster --services LiveInsight-service
```

### 2. API 엔드포인트 테스트
```bash
# API Gateway 테스트
API_URL=$(cd infrastructure && terraform output -raw api_gateway_url)
curl -X POST "$API_URL/events" \
  -H "Content-Type: application/json" \
  -d '{"event_type": "page_view", "page_url": "/test", "user_id": "test-user"}'

# Django API 테스트
ALB_DNS=$(cd infrastructure && terraform output -raw web_app_url | sed 's|http://||')
curl "http://$ALB_DNS/api/sessions/active/"
```

### 3. 헬스체크
```bash
# Django 애플리케이션 헬스체크
curl "http://$ALB_DNS/health/"

# 응답 시간 측정
curl -w "Time: %{time_total}s\n" "http://$ALB_DNS/api/sessions/active/"
```

## 📊 성능 테스트

### 부하 테스트
```bash
# 간단한 부하 테스트
for i in {1..10}; do
  curl -X POST "$API_URL/events" \
    -H "Content-Type: application/json" \
    -d "{\"event_type\": \"test\", \"user_id\": \"user_$i\"}" &
done
wait
```

### 캐시 성능 테스트
```bash
# 첫 번째 요청 (캐시 없음)
time curl -s "http://$ALB_DNS/api/sessions/active/" > /dev/null

# 두 번째 요청 (캐시 사용)
time curl -s "http://$ALB_DNS/api/sessions/active/" > /dev/null
```

## 🔧 테스트 시나리오

### E-commerce 시나리오
```bash
# 상품 페이지 조회
curl -X POST "$API_URL/events" \
  -H "Content-Type: application/json" \
  -d '{
    "event_type": "page_view",
    "page_url": "/product/123",
    "user_id": "customer_001"
  }'

# 장바구니 추가
curl -X POST "$API_URL/events" \
  -H "Content-Type: application/json" \
  -d '{
    "event_type": "add_to_cart",
    "page_url": "/product/123",
    "user_id": "customer_001",
    "product_id": "123"
  }'
```

## 🚨 문제 해결

### 테스트 실패 시 확인사항
1. **인프라 배포 상태**: `terraform output`으로 리소스 확인
2. **서비스 상태**: ECS 서비스와 Lambda 함수 상태 확인
3. **로그 확인**: CloudWatch 로그에서 에러 메시지 확인
4. **네트워크**: 보안 그룹과 라우팅 테이블 확인

### 로그 확인
```bash
# Lambda 로그
aws logs filter-log-events --log-group-name /aws/lambda/LiveInsight-EventCollector

# ECS 로그
aws logs filter-log-events --log-group-name /ecs/LiveInsight

# Django 애플리케이션 로그
aws ecs describe-tasks --cluster LiveInsight-cluster --tasks $(aws ecs list-tasks --cluster LiveInsight-cluster --service-name LiveInsight-service --query 'taskArns[0]' --output text)
```

## 📈 모니터링 확인

### CloudWatch 메트릭
```bash
# Lambda 메트릭 확인
aws cloudwatch get-metric-statistics \
  --namespace AWS/Lambda \
  --metric-name Duration \
  --dimensions Name=FunctionName,Value=LiveInsight-EventCollector \
  --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
  --period 300 \
  --statistics Average

# ECS 메트릭 확인
aws cloudwatch get-metric-statistics \
  --namespace AWS/ECS \
  --metric-name CPUUtilization \
  --dimensions Name=ServiceName,Value=LiveInsight-service Name=ClusterName,Value=LiveInsight-cluster \
  --start-time $(date -u -d '1 hour ago' +%Y-%m-%dT%H:%M:%S) \
  --end-time $(date -u +%Y-%m-%dT%H:%M:%S) \
  --period 300 \
  --statistics Average
```

### 대시보드 확인
- **CloudWatch 대시보드**: AWS 콘솔에서 LiveInsight 대시보드 확인
- **X-Ray 서비스 맵**: 분산 트레이싱 상태 확인
- **ECS 서비스 상태**: 태스크 실행 상태 및 헬스체크 확인