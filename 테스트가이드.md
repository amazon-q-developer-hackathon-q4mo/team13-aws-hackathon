# LiveInsight 인프라 테스트 가이드

## 📋 테스트 개요

이 문서는 LiveInsight 인프라의 모든 구성 요소를 검증하기 위한 종합 테스트 가이드입니다.

### 테스트 범위
- **Phase 1-5**: DynamoDB 테이블 상태 및 스키마 검증
- **Phase 1-5**: Lambda 함수 기능 및 성능 테스트
- **Phase 1-5**: API Gateway 엔드포인트 테스트
- **Phase 6**: ECS Fargate 및 Django 애플리케이션 테스트
- **Phase 6**: ALB 및 네트워킹 테스트
- **Phase 7**: 통합 테스트 및 성능 최적화 검증
- **Phase 7**: 고급 모니터링 시스템 검증
- **Phase 7**: 캐시 성능 및 블루-그린 배포 테스트
- 전체 시스템 End-to-End 테스트

## 🧪 테스트 코드

### 0. Phase 7 통합 테스트 스크립트

```bash
#!/bin/bash
# phase7_integration_test.sh

echo "🧪 Phase 7 통합 테스트 시작..."

# 필수 패키지 설치 확인
echo "📦 필수 패키지 설치 확인..."
pip3 install aiohttp boto3 requests > /dev/null 2>&1

# 배포 상태 확인
echo "🏗️ 배포 상태 확인..."
cd infrastructure/web-app
ALB_DNS=$(terraform output -raw alb_dns_name 2>/dev/null)
if [ -z "$ALB_DNS" ]; then
    echo "❌ Django 애플리케이션이 배포되지 않았습니다"
    exit 1
fi

cd ../
API_URL=$(terraform output -raw api_gateway_url 2>/dev/null)
if [ -z "$API_URL" ]; then
    echo "❌ Lambda API가 배포되지 않았습니다"
    exit 1
fi

cd ../

echo "✅ Django URL: http://$ALB_DNS"
echo "✅ Lambda API: $API_URL"

# E2E 테스트 실행
echo "🔄 E2E 테스트 실행..."
python3 tests/integration/test_e2e_flow.py "http://$ALB_DNS" "$API_URL"
if [ $? -ne 0 ]; then
    echo "❌ E2E 테스트 실패"
    exit 1
fi

# API 통합 테스트
echo "🔌 API 통합 테스트 실행..."
python3 tests/integration/test_api_integration.py "http://$ALB_DNS"
if [ $? -ne 0 ]; then
    echo "❌ API 통합 테스트 실패"
    exit 1
fi

# 성능 테스트
echo "⚡ 성능 테스트 실행..."
python3 tests/performance/load_test.py "http://$ALB_DNS" "$API_URL" 50 5
if [ $? -ne 0 ]; then
    echo "❌ 성능 테스트 실패"
    exit 1
fi

# 캐시 성능 테스트
echo "🚀 캐시 성능 테스트..."
echo "  첫 번째 요청 (캐시 없음):"
time curl -s "http://$ALB_DNS/api/sessions/active/" > /dev/null
echo "  두 번째 요청 (캐시 사용):"
time curl -s "http://$ALB_DNS/api/sessions/active/" > /dev/null

# 모니터링 시스템 확인
echo "📊 모니터링 시스템 확인..."
aws cloudwatch list-metrics --namespace LiveInsight --query 'Metrics[].MetricName' --output text
aws cloudwatch list-metrics --namespace AWS/ECS --query 'Metrics[?Dimensions[?Name==`ServiceName` && Value==`liveinsight-service`]].MetricName' --output text

echo "🎉 Phase 7 통합 테스트 완료!"
```

### 1. 인프라 상태 검증 스크립트

```bash
#!/bin/bash
# infrastructure_test.sh

echo "🔍 LiveInsight 인프라 상태 검증 시작..."

# DynamoDB 테이블 상태 확인
echo "📊 DynamoDB 테이블 상태 확인..."
for table in "LiveInsight-Events" "LiveInsight-Sessions" "LiveInsight-ActiveSessions"; do
    status=$(aws dynamodb describe-table --table-name $table --query 'Table.TableStatus' --output text 2>/dev/null)
    if [ "$status" = "ACTIVE" ]; then
        echo "✅ $table: ACTIVE"
    else
        echo "❌ $table: $status"
        exit 1
    fi
done

# Lambda 함수 상태 확인
echo "⚡ Lambda 함수 상태 확인..."
lambda_state=$(aws lambda get-function --function-name LiveInsight-EventCollector --query 'Configuration.State' --output text)
if [ "$lambda_state" = "Active" ]; then
    echo "✅ Lambda 함수: Active"
else
    echo "❌ Lambda 함수: $lambda_state"
    exit 1
fi

# API Gateway 상태 확인
echo "🌐 API Gateway 상태 확인..."
api_id=$(aws apigateway get-rest-apis --query 'items[?name==`LiveInsight-API`].id' --output text)
if [ -n "$api_id" ]; then
    echo "✅ API Gateway: $api_id"
else
    echo "❌ API Gateway를 찾을 수 없습니다"
    exit 1
fi

echo "🎉 모든 인프라 구성 요소가 정상 상태입니다!"
```

### 2. API 기능 테스트 스크립트

```python
#!/usr/bin/env python3
# api_test.py

import requests
import json
import time
import uuid
from datetime import datetime

class APITester:
    def __init__(self, api_url):
        self.api_url = api_url
        self.test_results = []
    
    def test_cors_preflight(self):
        """CORS preflight 요청 테스트"""
        print("🔒 CORS preflight 테스트...")
        try:
            response = requests.options(self.api_url, timeout=10)
            assert response.status_code == 200
            assert 'Access-Control-Allow-Origin' in response.headers
            print("✅ CORS preflight 성공")
            return True
        except Exception as e:
            print(f"❌ CORS preflight 실패: {e}")
            return False
    
    def test_event_creation(self):
        """이벤트 생성 테스트"""
        print("📝 이벤트 생성 테스트...")
        test_data = {
            "user_id": f"test_user_{uuid.uuid4().hex[:8]}",
            "event_type": "page_view",
            "page_url": "https://example.com/test",
            "referrer": "https://google.com",
            "user_agent": "TestAgent/1.0"
        }
        
        try:
            response = requests.post(self.api_url, json=test_data, timeout=10)
            assert response.status_code == 200
            
            result = response.json()
            assert 'event_id' in result
            assert 'session_id' in result
            assert result['message'] == 'Event processed successfully'
            
            print(f"✅ 이벤트 생성 성공: {result['event_id']}")
            return result
        except Exception as e:
            print(f"❌ 이벤트 생성 실패: {e}")
            return None
    
    def test_session_continuity(self):
        """세션 연속성 테스트"""
        print("🔗 세션 연속성 테스트...")
        user_id = f"session_test_{uuid.uuid4().hex[:8]}"
        
        # 첫 번째 이벤트
        first_event = {
            "user_id": user_id,
            "event_type": "page_view",
            "page_url": "https://example.com/page1"
        }
        
        try:
            response1 = requests.post(self.api_url, json=first_event, timeout=10)
            result1 = response1.json()
            session_id = result1['session_id']
            
            # 같은 세션으로 두 번째 이벤트
            second_event = {
                "user_id": user_id,
                "session_id": session_id,
                "event_type": "click",
                "page_url": "https://example.com/page2"
            }
            
            time.sleep(1)  # 잠시 대기
            response2 = requests.post(self.api_url, json=second_event, timeout=10)
            result2 = response2.json()
            
            assert result1['session_id'] == result2['session_id']
            print(f"✅ 세션 연속성 확인: {session_id}")
            return True
        except Exception as e:
            print(f"❌ 세션 연속성 테스트 실패: {e}")
            return False
    
    def test_error_handling(self):
        """에러 처리 테스트"""
        print("🚨 에러 처리 테스트...")
        
        # 잘못된 JSON 전송
        try:
            response = requests.post(
                self.api_url, 
                data="invalid json", 
                headers={'Content-Type': 'application/json'},
                timeout=10
            )
            assert response.status_code == 500
            print("✅ 잘못된 JSON 에러 처리 확인")
            return True
        except Exception as e:
            print(f"❌ 에러 처리 테스트 실패: {e}")
            return False
    
    def run_all_tests(self):
        """모든 테스트 실행"""
        print(f"🧪 API 테스트 시작: {self.api_url}")
        print("-" * 50)
        
        tests = [
            self.test_cors_preflight,
            self.test_event_creation,
            self.test_session_continuity,
            self.test_error_handling
        ]
        
        passed = 0
        for test in tests:
            if test():
                passed += 1
            print()
        
        print(f"📊 테스트 결과: {passed}/{len(tests)} 통과")
        return passed == len(tests)

if __name__ == "__main__":
    API_URL = "https://qnwoi1ardd.execute-api.us-east-1.amazonaws.com/prod/events"
    tester = APITester(API_URL)
    success = tester.run_all_tests()
    exit(0 if success else 1)
```

### 3. DynamoDB 데이터 검증 스크립트

```python
#!/usr/bin/env python3
# dynamodb_test.py

import boto3
import json
from datetime import datetime, timedelta

class DynamoDBTester:
    def __init__(self):
        self.dynamodb = boto3.resource('dynamodb', region_name='us-east-1')
        self.events_table = self.dynamodb.Table('LiveInsight-Events')
        self.sessions_table = self.dynamodb.Table('LiveInsight-Sessions')
        self.active_sessions_table = self.dynamodb.Table('LiveInsight-ActiveSessions')
    
    def test_table_schemas(self):
        """테이블 스키마 검증"""
        print("📋 DynamoDB 테이블 스키마 검증...")
        
        # Events 테이블 스키마 확인
        events_schema = self.events_table.key_schema
        assert len(events_schema) == 2
        assert events_schema[0]['AttributeName'] == 'event_id'
        assert events_schema[1]['AttributeName'] == 'timestamp'
        print("✅ Events 테이블 스키마 정상")
        
        # Sessions 테이블 스키마 확인
        sessions_schema = self.sessions_table.key_schema
        assert len(sessions_schema) == 1
        assert sessions_schema[0]['AttributeName'] == 'session_id'
        print("✅ Sessions 테이블 스키마 정상")
        
        # ActiveSessions 테이블 스키마 확인
        active_schema = self.active_sessions_table.key_schema
        assert len(active_schema) == 1
        assert active_schema[0]['AttributeName'] == 'session_id'
        print("✅ ActiveSessions 테이블 스키마 정상")
        
        return True
    
    def test_data_integrity(self):
        """데이터 무결성 검증"""
        print("🔍 데이터 무결성 검증...")
        
        # 최근 이벤트 조회
        try:
            response = self.events_table.scan(Limit=5)
            events = response.get('Items', [])
            
            for event in events:
                # 필수 필드 확인
                required_fields = ['event_id', 'timestamp', 'user_id', 'session_id', 'event_type']
                for field in required_fields:
                    assert field in event, f"필수 필드 {field}가 없습니다"
                
                # 데이터 타입 확인
                assert isinstance(event['timestamp'], int), "timestamp는 숫자여야 합니다"
                assert isinstance(event['event_id'], str), "event_id는 문자열이어야 합니다"
            
            print(f"✅ {len(events)}개 이벤트 데이터 무결성 확인")
            return True
        except Exception as e:
            print(f"❌ 데이터 무결성 검증 실패: {e}")
            return False
    
    def test_ttl_configuration(self):
        """TTL 설정 확인"""
        print("⏰ TTL 설정 확인...")
        
        try:
            client = boto3.client('dynamodb', region_name='us-east-1')
            ttl_response = client.describe_time_to_live(TableName='LiveInsight-ActiveSessions')
            
            ttl_status = ttl_response['TimeToLiveDescription']['TimeToLiveStatus']
            assert ttl_status == 'ENABLED', f"TTL이 활성화되지 않음: {ttl_status}"
            
            ttl_attribute = ttl_response['TimeToLiveDescription']['AttributeName']
            assert ttl_attribute == 'expires_at', f"TTL 속성명이 잘못됨: {ttl_attribute}"
            
            print("✅ ActiveSessions TTL 설정 정상")
            return True
        except Exception as e:
            print(f"❌ TTL 설정 확인 실패: {e}")
            return False
    
    def run_all_tests(self):
        """모든 DynamoDB 테스트 실행"""
        print("🗄️ DynamoDB 테스트 시작...")
        print("-" * 50)
        
        tests = [
            self.test_table_schemas,
            self.test_data_integrity,
            self.test_ttl_configuration
        ]
        
        passed = 0
        for test in tests:
            try:
                if test():
                    passed += 1
            except Exception as e:
                print(f"❌ 테스트 실행 중 오류: {e}")
            print()
        
        print(f"📊 DynamoDB 테스트 결과: {passed}/{len(tests)} 통과")
        return passed == len(tests)

if __name__ == "__main__":
    tester = DynamoDBTester()
    success = tester.run_all_tests()
    exit(0 if success else 1)
```

### 4. CloudWatch 모니터링 검증 스크립트

```python
#!/usr/bin/env python3
# monitoring_test.py

import boto3
import time
from datetime import datetime, timedelta

class MonitoringTester:
    def __init__(self):
        self.cloudwatch = boto3.client('cloudwatch', region_name='us-east-1')
    
    def test_custom_metrics(self):
        """커스텀 메트릭 확인"""
        print("📈 커스텀 메트릭 확인...")
        
        try:
            # LiveInsight 네임스페이스의 메트릭 조회
            response = self.cloudwatch.list_metrics(Namespace='LiveInsight')
            metrics = response.get('Metrics', [])
            
            expected_metrics = ['EventsProcessed', 'ProcessingTime']
            found_metrics = [m['MetricName'] for m in metrics]
            
            for metric in expected_metrics:
                assert metric in found_metrics, f"메트릭 {metric}을 찾을 수 없습니다"
            
            print(f"✅ 커스텀 메트릭 {len(found_metrics)}개 확인")
            return True
        except Exception as e:
            print(f"❌ 커스텀 메트릭 확인 실패: {e}")
            return False
    
    def test_alarms(self):
        """CloudWatch 알람 확인"""
        print("🚨 CloudWatch 알람 확인...")
        
        expected_alarms = [
            'LiveInsight-Lambda-ErrorRate',
            'LiveInsight-Lambda-Duration', 
            'LiveInsight-DynamoDB-Throttles'
        ]
        
        try:
            response = self.cloudwatch.describe_alarms(AlarmNames=expected_alarms)
            alarms = response.get('MetricAlarms', [])
            
            assert len(alarms) == len(expected_alarms), f"알람 개수 불일치: {len(alarms)}/{len(expected_alarms)}"
            
            for alarm in alarms:
                print(f"  📊 {alarm['AlarmName']}: {alarm['StateValue']}")
            
            print("✅ 모든 알람 설정 확인")
            return True
        except Exception as e:
            print(f"❌ 알람 확인 실패: {e}")
            return False
    
    def test_lambda_logs(self):
        """Lambda 로그 확인"""
        print("📝 Lambda 로그 확인...")
        
        try:
            logs_client = boto3.client('logs', region_name='us-east-1')
            
            # 로그 그룹 존재 확인
            log_group = '/aws/lambda/LiveInsight-EventCollector'
            response = logs_client.describe_log_groups(logGroupNamePrefix=log_group)
            
            assert len(response['logGroups']) > 0, "Lambda 로그 그룹을 찾을 수 없습니다"
            
            # 최근 로그 스트림 확인
            streams_response = logs_client.describe_log_streams(
                logGroupName=log_group,
                orderBy='LastEventTime',
                descending=True,
                limit=1
            )
            
            assert len(streams_response['logStreams']) > 0, "로그 스트림이 없습니다"
            
            print("✅ Lambda 로그 시스템 정상")
            return True
        except Exception as e:
            print(f"❌ Lambda 로그 확인 실패: {e}")
            return False
    
    def run_all_tests(self):
        """모든 모니터링 테스트 실행"""
        print("📊 모니터링 시스템 테스트 시작...")
        print("-" * 50)
        
        tests = [
            self.test_custom_metrics,
            self.test_alarms,
            self.test_lambda_logs
        ]
        
        passed = 0
        for test in tests:
            try:
                if test():
                    passed += 1
            except Exception as e:
                print(f"❌ 테스트 실행 중 오류: {e}")
            print()
        
        print(f"📊 모니터링 테스트 결과: {passed}/{len(tests)} 통과")
        return passed == len(tests)

if __name__ == "__main__":
    tester = MonitoringTester()
    success = tester.run_all_tests()
    exit(0 if success else 1)
```

## 🚀 테스트 실행 가이드

### 1. 사전 준비

```bash
# 필요한 Python 패키지 설치 (Phase 7 추가)
pip3 install requests boto3 aiohttp

# AWS 자격 증명 확인
aws sts get-caller-identity

# 모든 테스트 스크립트 실행 권한 부여
chmod +x infrastructure_test.sh
chmod +x phase7_integration_test.sh
chmod +x scripts/*.sh

# Phase 7 테스트 디렉토리 확인
ls -la tests/integration/ tests/performance/
```

### 2. Phase 7 통합 테스트 실행 (권장)

```bash
# Phase 7 전체 통합 테스트
./scripts/run-tests.sh all

# 또는 개별 테스트
./scripts/run-tests.sh e2e
./scripts/run-tests.sh performance

# Phase 7 전용 테스트
./phase7_integration_test.sh
```

### 3. 기존 테스트 실행 (Phase 1-6)

```bash
# 1. 인프라 상태 검증
./infrastructure_test.sh

# 2. API 기능 테스트
python3 api_test.py

# 3. DynamoDB 검증
python3 dynamodb_test.py

# 4. 모니터링 시스템 검증
python3 monitoring_test.py

# 5. Django 애플리케이션 테스트
./scripts/test.sh local
./scripts/test.sh deployment
```

### 4. 레거시 통합 테스트 스크립트 (Phase 1-6)

```bash
#!/bin/bash
# run_all_tests.sh

echo "🧪 LiveInsight 전체 시스템 테스트 시작..."
echo "================================================"

# 인프라 상태 검증
echo "1️⃣ 인프라 상태 검증..."
./infrastructure_test.sh
if [ $? -ne 0 ]; then
    echo "❌ 인프라 테스트 실패"
    exit 1
fi

# API 기능 테스트
echo -e "\n2️⃣ API 기능 테스트..."
python3 api_test.py
if [ $? -ne 0 ]; then
    echo "❌ API 테스트 실패"
    exit 1
fi

# DynamoDB 검증
echo -e "\n3️⃣ DynamoDB 검증..."
python3 dynamodb_test.py
if [ $? -ne 0 ]; then
    echo "❌ DynamoDB 테스트 실패"
    exit 1
fi

# 모니터링 시스템 검증
echo -e "\n4️⃣ 모니터링 시스템 검증..."
python3 monitoring_test.py
if [ $? -ne 0 ]; then
    echo "❌ 모니터링 테스트 실패"
    exit 1
fi

echo -e "\n🎉 모든 테스트 통과! LiveInsight 시스템이 정상 동작합니다."
```

## 📊 테스트 결과 해석

### Phase 7 성공 기준
- ✅ **E2E 테스트**: JavaScript → Lambda → DynamoDB → Django API 전체 플로우 정상
- ✅ **성능 목표**: API 응답시간 200ms 이하, 동시 사용자 50-100명 지원
- ✅ **캐시 성능**: 두 번째 요청이 첫 번째보다 빠름 (30초 캐시)
- ✅ **고급 모니터링**: 커스텀 메트릭, X-Ray 트레이싱 정상 동작
- ✅ **블루-그린 배포**: 무중단 배포 및 자동 롤백 기능
- ✅ **Django 애플리케이션**: ECS Fargate에서 정상 실행, ALB 헬스체크 통과

### Phase 8 성공 기준
- ✅ **HTTPS 도메인**: SSL/TLS 인증서 적용 완료
- ✅ **CDN 성능**: CloudFront 글로벌 배포, 정적 자산 캐시 최적화
- ✅ **WAF 보안**: 웹 애플리케이션 방화벽 적용, 속도 제한 및 보안 규칙
- ✅ **위협 탐지**: GuardDuty 활성화, VPC Flow Logs 모니터링
- ✅ **도메인 관리**: Route 53 DNS, 서브도메인 구성, 헬스체크
- ✅ **환경 관리**: Parameter Store, KMS 암호화, 통합 대시보드

### 기존 성공 기준 (Phase 1-6)
- ✅ 모든 AWS 리소스가 ACTIVE 상태
- ✅ API 엔드포인트가 정상 응답 (HTTP 200)
- ✅ CORS 설정이 올바르게 동작
- ✅ 이벤트 데이터가 DynamoDB에 정상 저장
- ✅ 세션 관리가 올바르게 동작
- ✅ CloudWatch 메트릭 및 알람이 정상 설정
- ✅ Lambda 로그가 정상 생성

### Phase 7 실패 시 대응 방안
1. **E2E 테스트 실패**: 
   ```bash
   # Lambda 및 Django 로그 확인
   aws logs tail /aws/lambda/LiveInsight-EventCollector --follow
   aws logs tail /ecs/liveinsight --follow
   ```

2. **성능 테스트 실패**:
   ```bash
   # ECS 서비스 스케일링 확인
   aws ecs describe-services --cluster liveinsight-cluster --services liveinsight-service
   # 캐시 설정 확인
   curl "http://ALB_DNS/api/sessions/active/" -H "Cache-Control: no-cache"
   ```

3. **블루-그린 배포 실패**:
   ```bash
   # 롤백 실행
   ./scripts/rollback.sh
   # 태스크 정의 확인
   aws ecs describe-task-definition --task-definition liveinsight-task
   ```

4. **모니터링 실패**:
   ```bash
   # X-Ray 서비스 맵 확인
   aws xray get-service-graph --start-time $(date -d '1 hour ago' +%s) --end-time $(date +%s)
   # 커스텀 메트릭 확인
   aws cloudwatch get-metric-statistics --namespace LiveInsight --metric-name EventsProcessed --start-time $(date -d '1 hour ago' --iso-8601) --end-time $(date --iso-8601) --period 300 --statistics Sum
   ```

### 기존 실패 시 대응 방안 (Phase 1-6)
1. **인프라 상태 실패**: `terraform plan` 및 `terraform apply` 재실행
2. **API 테스트 실패**: Lambda 함수 로그 확인 및 코드 검토
3. **DynamoDB 실패**: 테이블 스키마 및 권한 확인
4. **모니터링 실패**: CloudWatch 설정 및 IAM 권한 확인

## 🔄 정기 테스트 권장사항

### 일일 테스트 (Phase 7 포함)
```bash
# 기본 상태 확인
./infrastructure_test.sh

# Django 애플리케이션 헬스체크
./scripts/test.sh deployment

# 캐시 성능 간단 확인
time curl -s "http://$(cd infrastructure/web-app && terraform output -raw alb_dns_name)/api/sessions/active/" > /dev/null
```

### 주간 테스트 (Phase 7 전체)
```bash
# Phase 7 통합 테스트
./scripts/run-tests.sh all

# 또는 레거시 테스트
./run_all_tests.sh

# 성능 벤치마크
./scripts/run-tests.sh performance
```

### 배포 후 테스트 (Phase 7-8 추가)
```bash
# 블루-그린 배포 후 검증
./scripts/blue-green-deploy.sh && ./scripts/run-tests.sh all

# 일반 배포 후 검증
./scripts/deploy.sh && ./phase7_integration_test.sh

# Phase 8 배포 후 검증
./scripts/deploy-phase8.sh prod liveinsight-demo.com && ./scripts/test-phase8.sh prod liveinsight-demo.com

# 롤백 테스트
./scripts/rollback.sh && ./scripts/test.sh deployment
```

### 성능 모니터링 (Phase 7)
```bash
# 주간 성능 리포트
echo "📊 주간 성능 리포트:"
aws cloudwatch get-metric-statistics \
  --namespace AWS/ApplicationELB \
  --metric-name TargetResponseTime \
  --start-time $(date -d '7 days ago' --iso-8601) \
  --end-time $(date --iso-8601) \
  --period 86400 \
  --statistics Average

# 캐시 히트율 모니터링
echo "🚀 캐시 성능 모니터링:"
for i in {1..5}; do
  time curl -s "http://$(cd infrastructure/web-app && terraform output -raw alb_dns_name)/api/sessions/active/" > /dev/null
  sleep 1
done
```

이 테스트 가이드를 통해 LiveInsight 인프라의 모든 구성 요소가 올바르게 동작하는지 체계적으로 검증할 수 있습니다.