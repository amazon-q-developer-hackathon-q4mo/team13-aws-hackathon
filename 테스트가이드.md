# LiveInsight 인프라 테스트 가이드

## 📋 테스트 개요

이 문서는 LiveInsight 인프라의 모든 구성 요소를 검증하기 위한 종합 테스트 가이드입니다.

### 테스트 범위
- DynamoDB 테이블 상태 및 스키마 검증
- Lambda 함수 기능 및 성능 테스트
- API Gateway 엔드포인트 테스트
- CloudWatch 모니터링 시스템 검증
- 전체 시스템 통합 테스트

## 🧪 테스트 코드

### 1. 인프라 상태 검증 스크립트

```bash
#!/bin/bash
# infrastructure_test.sh

echo "🔍 LiveInsight 인프라 상태 검증 시작..."

# DynamoDB 테이블 상태 확인
echo "📊 DynamoDB 테이블 상태 확인..."
for table in "LiveInsight-Events" "LiveInsight-Sessions" "LiveInsight-ActiveSessions"; do
    status=$(aws dynamodb describe-table --table-name $table --query 'Table.TableStatus' --output text 2>/dev/null)
    if [ "$status" = "ACTIVE" ]; then
        echo "✅ $table: ACTIVE"
    else
        echo "❌ $table: $status"
        exit 1
    fi
done

# Lambda 함수 상태 확인
echo "⚡ Lambda 함수 상태 확인..."
lambda_state=$(aws lambda get-function --function-name LiveInsight-EventCollector --query 'Configuration.State' --output text)
if [ "$lambda_state" = "Active" ]; then
    echo "✅ Lambda 함수: Active"
else
    echo "❌ Lambda 함수: $lambda_state"
    exit 1
fi

# API Gateway 상태 확인
echo "🌐 API Gateway 상태 확인..."
api_id=$(aws apigateway get-rest-apis --query 'items[?name==`LiveInsight-API`].id' --output text)
if [ -n "$api_id" ]; then
    echo "✅ API Gateway: $api_id"
else
    echo "❌ API Gateway를 찾을 수 없습니다"
    exit 1
fi

echo "🎉 모든 인프라 구성 요소가 정상 상태입니다!"
```

### 2. API 기능 테스트 스크립트

```python
#!/usr/bin/env python3
# api_test.py

import requests
import json
import time
import uuid
from datetime import datetime

class APITester:
    def __init__(self, api_url):
        self.api_url = api_url
        self.test_results = []
    
    def test_cors_preflight(self):
        """CORS preflight 요청 테스트"""
        print("🔒 CORS preflight 테스트...")
        try:
            response = requests.options(self.api_url, timeout=10)
            assert response.status_code == 200
            assert 'Access-Control-Allow-Origin' in response.headers
            print("✅ CORS preflight 성공")
            return True
        except Exception as e:
            print(f"❌ CORS preflight 실패: {e}")
            return False
    
    def test_event_creation(self):
        """이벤트 생성 테스트"""
        print("📝 이벤트 생성 테스트...")
        test_data = {
            "user_id": f"test_user_{uuid.uuid4().hex[:8]}",
            "event_type": "page_view",
            "page_url": "https://example.com/test",
            "referrer": "https://google.com",
            "user_agent": "TestAgent/1.0"
        }
        
        try:
            response = requests.post(self.api_url, json=test_data, timeout=10)
            assert response.status_code == 200
            
            result = response.json()
            assert 'event_id' in result
            assert 'session_id' in result
            assert result['message'] == 'Event processed successfully'
            
            print(f"✅ 이벤트 생성 성공: {result['event_id']}")
            return result
        except Exception as e:
            print(f"❌ 이벤트 생성 실패: {e}")
            return None
    
    def test_session_continuity(self):
        """세션 연속성 테스트"""
        print("🔗 세션 연속성 테스트...")
        user_id = f"session_test_{uuid.uuid4().hex[:8]}"
        
        # 첫 번째 이벤트
        first_event = {
            "user_id": user_id,
            "event_type": "page_view",
            "page_url": "https://example.com/page1"
        }
        
        try:
            response1 = requests.post(self.api_url, json=first_event, timeout=10)
            result1 = response1.json()
            session_id = result1['session_id']
            
            # 같은 세션으로 두 번째 이벤트
            second_event = {
                "user_id": user_id,
                "session_id": session_id,
                "event_type": "click",
                "page_url": "https://example.com/page2"
            }
            
            time.sleep(1)  # 잠시 대기
            response2 = requests.post(self.api_url, json=second_event, timeout=10)
            result2 = response2.json()
            
            assert result1['session_id'] == result2['session_id']
            print(f"✅ 세션 연속성 확인: {session_id}")
            return True
        except Exception as e:
            print(f"❌ 세션 연속성 테스트 실패: {e}")
            return False
    
    def test_error_handling(self):
        """에러 처리 테스트"""
        print("🚨 에러 처리 테스트...")
        
        # 잘못된 JSON 전송
        try:
            response = requests.post(
                self.api_url, 
                data="invalid json", 
                headers={'Content-Type': 'application/json'},
                timeout=10
            )
            assert response.status_code == 500
            print("✅ 잘못된 JSON 에러 처리 확인")
            return True
        except Exception as e:
            print(f"❌ 에러 처리 테스트 실패: {e}")
            return False
    
    def run_all_tests(self):
        """모든 테스트 실행"""
        print(f"🧪 API 테스트 시작: {self.api_url}")
        print("-" * 50)
        
        tests = [
            self.test_cors_preflight,
            self.test_event_creation,
            self.test_session_continuity,
            self.test_error_handling
        ]
        
        passed = 0
        for test in tests:
            if test():
                passed += 1
            print()
        
        print(f"📊 테스트 결과: {passed}/{len(tests)} 통과")
        return passed == len(tests)

if __name__ == "__main__":
    API_URL = "https://qnwoi1ardd.execute-api.us-east-1.amazonaws.com/prod/events"
    tester = APITester(API_URL)
    success = tester.run_all_tests()
    exit(0 if success else 1)
```

### 3. DynamoDB 데이터 검증 스크립트

```python
#!/usr/bin/env python3
# dynamodb_test.py

import boto3
import json
from datetime import datetime, timedelta

class DynamoDBTester:
    def __init__(self):
        self.dynamodb = boto3.resource('dynamodb', region_name='us-east-1')
        self.events_table = self.dynamodb.Table('LiveInsight-Events')
        self.sessions_table = self.dynamodb.Table('LiveInsight-Sessions')
        self.active_sessions_table = self.dynamodb.Table('LiveInsight-ActiveSessions')
    
    def test_table_schemas(self):
        """테이블 스키마 검증"""
        print("📋 DynamoDB 테이블 스키마 검증...")
        
        # Events 테이블 스키마 확인
        events_schema = self.events_table.key_schema
        assert len(events_schema) == 2
        assert events_schema[0]['AttributeName'] == 'event_id'
        assert events_schema[1]['AttributeName'] == 'timestamp'
        print("✅ Events 테이블 스키마 정상")
        
        # Sessions 테이블 스키마 확인
        sessions_schema = self.sessions_table.key_schema
        assert len(sessions_schema) == 1
        assert sessions_schema[0]['AttributeName'] == 'session_id'
        print("✅ Sessions 테이블 스키마 정상")
        
        # ActiveSessions 테이블 스키마 확인
        active_schema = self.active_sessions_table.key_schema
        assert len(active_schema) == 1
        assert active_schema[0]['AttributeName'] == 'session_id'
        print("✅ ActiveSessions 테이블 스키마 정상")
        
        return True
    
    def test_data_integrity(self):
        """데이터 무결성 검증"""
        print("🔍 데이터 무결성 검증...")
        
        # 최근 이벤트 조회
        try:
            response = self.events_table.scan(Limit=5)
            events = response.get('Items', [])
            
            for event in events:
                # 필수 필드 확인
                required_fields = ['event_id', 'timestamp', 'user_id', 'session_id', 'event_type']
                for field in required_fields:
                    assert field in event, f"필수 필드 {field}가 없습니다"
                
                # 데이터 타입 확인
                assert isinstance(event['timestamp'], int), "timestamp는 숫자여야 합니다"
                assert isinstance(event['event_id'], str), "event_id는 문자열이어야 합니다"
            
            print(f"✅ {len(events)}개 이벤트 데이터 무결성 확인")
            return True
        except Exception as e:
            print(f"❌ 데이터 무결성 검증 실패: {e}")
            return False
    
    def test_ttl_configuration(self):
        """TTL 설정 확인"""
        print("⏰ TTL 설정 확인...")
        
        try:
            client = boto3.client('dynamodb', region_name='us-east-1')
            ttl_response = client.describe_time_to_live(TableName='LiveInsight-ActiveSessions')
            
            ttl_status = ttl_response['TimeToLiveDescription']['TimeToLiveStatus']
            assert ttl_status == 'ENABLED', f"TTL이 활성화되지 않음: {ttl_status}"
            
            ttl_attribute = ttl_response['TimeToLiveDescription']['AttributeName']
            assert ttl_attribute == 'expires_at', f"TTL 속성명이 잘못됨: {ttl_attribute}"
            
            print("✅ ActiveSessions TTL 설정 정상")
            return True
        except Exception as e:
            print(f"❌ TTL 설정 확인 실패: {e}")
            return False
    
    def run_all_tests(self):
        """모든 DynamoDB 테스트 실행"""
        print("🗄️ DynamoDB 테스트 시작...")
        print("-" * 50)
        
        tests = [
            self.test_table_schemas,
            self.test_data_integrity,
            self.test_ttl_configuration
        ]
        
        passed = 0
        for test in tests:
            try:
                if test():
                    passed += 1
            except Exception as e:
                print(f"❌ 테스트 실행 중 오류: {e}")
            print()
        
        print(f"📊 DynamoDB 테스트 결과: {passed}/{len(tests)} 통과")
        return passed == len(tests)

if __name__ == "__main__":
    tester = DynamoDBTester()
    success = tester.run_all_tests()
    exit(0 if success else 1)
```

### 4. CloudWatch 모니터링 검증 스크립트

```python
#!/usr/bin/env python3
# monitoring_test.py

import boto3
import time
from datetime import datetime, timedelta

class MonitoringTester:
    def __init__(self):
        self.cloudwatch = boto3.client('cloudwatch', region_name='us-east-1')
    
    def test_custom_metrics(self):
        """커스텀 메트릭 확인"""
        print("📈 커스텀 메트릭 확인...")
        
        try:
            # LiveInsight 네임스페이스의 메트릭 조회
            response = self.cloudwatch.list_metrics(Namespace='LiveInsight')
            metrics = response.get('Metrics', [])
            
            expected_metrics = ['EventsProcessed', 'ProcessingTime']
            found_metrics = [m['MetricName'] for m in metrics]
            
            for metric in expected_metrics:
                assert metric in found_metrics, f"메트릭 {metric}을 찾을 수 없습니다"
            
            print(f"✅ 커스텀 메트릭 {len(found_metrics)}개 확인")
            return True
        except Exception as e:
            print(f"❌ 커스텀 메트릭 확인 실패: {e}")
            return False
    
    def test_alarms(self):
        """CloudWatch 알람 확인"""
        print("🚨 CloudWatch 알람 확인...")
        
        expected_alarms = [
            'LiveInsight-Lambda-ErrorRate',
            'LiveInsight-Lambda-Duration', 
            'LiveInsight-DynamoDB-Throttles'
        ]
        
        try:
            response = self.cloudwatch.describe_alarms(AlarmNames=expected_alarms)
            alarms = response.get('MetricAlarms', [])
            
            assert len(alarms) == len(expected_alarms), f"알람 개수 불일치: {len(alarms)}/{len(expected_alarms)}"
            
            for alarm in alarms:
                print(f"  📊 {alarm['AlarmName']}: {alarm['StateValue']}")
            
            print("✅ 모든 알람 설정 확인")
            return True
        except Exception as e:
            print(f"❌ 알람 확인 실패: {e}")
            return False
    
    def test_lambda_logs(self):
        """Lambda 로그 확인"""
        print("📝 Lambda 로그 확인...")
        
        try:
            logs_client = boto3.client('logs', region_name='us-east-1')
            
            # 로그 그룹 존재 확인
            log_group = '/aws/lambda/LiveInsight-EventCollector'
            response = logs_client.describe_log_groups(logGroupNamePrefix=log_group)
            
            assert len(response['logGroups']) > 0, "Lambda 로그 그룹을 찾을 수 없습니다"
            
            # 최근 로그 스트림 확인
            streams_response = logs_client.describe_log_streams(
                logGroupName=log_group,
                orderBy='LastEventTime',
                descending=True,
                limit=1
            )
            
            assert len(streams_response['logStreams']) > 0, "로그 스트림이 없습니다"
            
            print("✅ Lambda 로그 시스템 정상")
            return True
        except Exception as e:
            print(f"❌ Lambda 로그 확인 실패: {e}")
            return False
    
    def run_all_tests(self):
        """모든 모니터링 테스트 실행"""
        print("📊 모니터링 시스템 테스트 시작...")
        print("-" * 50)
        
        tests = [
            self.test_custom_metrics,
            self.test_alarms,
            self.test_lambda_logs
        ]
        
        passed = 0
        for test in tests:
            try:
                if test():
                    passed += 1
            except Exception as e:
                print(f"❌ 테스트 실행 중 오류: {e}")
            print()
        
        print(f"📊 모니터링 테스트 결과: {passed}/{len(tests)} 통과")
        return passed == len(tests)

if __name__ == "__main__":
    tester = MonitoringTester()
    success = tester.run_all_tests()
    exit(0 if success else 1)
```

## 🚀 테스트 실행 가이드

### 1. 사전 준비

```bash
# 필요한 Python 패키지 설치
pip3 install requests boto3

# AWS 자격 증명 확인
aws sts get-caller-identity

# 실행 권한 부여
chmod +x infrastructure_test.sh
```

### 2. 전체 테스트 실행

```bash
# 1. 인프라 상태 검증
./infrastructure_test.sh

# 2. API 기능 테스트
python3 api_test.py

# 3. DynamoDB 검증
python3 dynamodb_test.py

# 4. 모니터링 시스템 검증
python3 monitoring_test.py
```

### 3. 통합 테스트 스크립트

```bash
#!/bin/bash
# run_all_tests.sh

echo "🧪 LiveInsight 전체 시스템 테스트 시작..."
echo "================================================"

# 인프라 상태 검증
echo "1️⃣ 인프라 상태 검증..."
./infrastructure_test.sh
if [ $? -ne 0 ]; then
    echo "❌ 인프라 테스트 실패"
    exit 1
fi

# API 기능 테스트
echo -e "\n2️⃣ API 기능 테스트..."
python3 api_test.py
if [ $? -ne 0 ]; then
    echo "❌ API 테스트 실패"
    exit 1
fi

# DynamoDB 검증
echo -e "\n3️⃣ DynamoDB 검증..."
python3 dynamodb_test.py
if [ $? -ne 0 ]; then
    echo "❌ DynamoDB 테스트 실패"
    exit 1
fi

# 모니터링 시스템 검증
echo -e "\n4️⃣ 모니터링 시스템 검증..."
python3 monitoring_test.py
if [ $? -ne 0 ]; then
    echo "❌ 모니터링 테스트 실패"
    exit 1
fi

echo -e "\n🎉 모든 테스트 통과! LiveInsight 시스템이 정상 동작합니다."
```

## 📊 테스트 결과 해석

### 성공 기준
- ✅ 모든 AWS 리소스가 ACTIVE 상태
- ✅ API 엔드포인트가 정상 응답 (HTTP 200)
- ✅ CORS 설정이 올바르게 동작
- ✅ 이벤트 데이터가 DynamoDB에 정상 저장
- ✅ 세션 관리가 올바르게 동작
- ✅ CloudWatch 메트릭 및 알람이 정상 설정
- ✅ Lambda 로그가 정상 생성

### 실패 시 대응 방안
1. **인프라 상태 실패**: `terraform plan` 및 `terraform apply` 재실행
2. **API 테스트 실패**: Lambda 함수 로그 확인 및 코드 검토
3. **DynamoDB 실패**: 테이블 스키마 및 권한 확인
4. **모니터링 실패**: CloudWatch 설정 및 IAM 권한 확인

## 🔄 정기 테스트 권장사항

### 일일 테스트
```bash
# 기본 상태 확인
./infrastructure_test.sh && python3 api_test.py
```

### 주간 테스트
```bash
# 전체 시스템 검증
./run_all_tests.sh
```

### 배포 후 테스트
```bash
# 배포 검증
./run_all_tests.sh && echo "배포 검증 완료"
```

이 테스트 가이드를 통해 LiveInsight 인프라의 모든 구성 요소가 올바르게 동작하는지 체계적으로 검증할 수 있습니다.