# LiveInsight 배포 가이드

## 📋 배포 개요

LiveInsight는 AWS 서버리스 아키텍처를 기반으로 한 실시간 웹사이트 사용자 행동 분석 서비스입니다. 이 가이드는 전체 인프라를 처음부터 배포하는 방법을 설명합니다.

## 🏗️ 아키텍처 다이어그램

```
┌─────────────┐    ┌──────────────┐    ┌─────────────┐    ┌──────────────┐
│   웹사이트   │───▶│ API Gateway  │───▶│   Lambda    │───▶│  DynamoDB    │
│ (JS 추적)   │    │              │    │ EventCollector│    │   Tables     │
└─────────────┘    └──────────────┘    └─────────────┘    └──────────────┘
                           │                    │                   │
                           │                    ▼                   │
                           │            ┌─────────────┐             │
                           │            │ CloudWatch  │             │
                           │            │ Monitoring  │             │
                           │            │ + X-Ray     │             │
                           │            └─────────────┘             │
                           │                                        │
                           ▼                                        ▼
                   ┌──────────────┐                        ┌──────────────┐
                   │ Django API   │◀───────────────────────│ ActiveSessions│
                   │ (ECS Fargate)│                        │   (TTL 30분)  │
                   │ + 캐시 최적화 │                        │              │
                   └──────────────┘                        └──────────────┘
                           │
                           ▼
                   ┌──────────────┐
                   │     ALB      │
                   │ (Load Balancer)│
                   └──────────────┘
```

## 🛠️ 사전 요구사항

### 필수 도구
- **AWS CLI** (v2.0+)
- **Terraform** (v1.0+)
- **Python** (3.11+)
- **Docker** (20.0+)
- **Git**
- **jq** (JSON 처리용)

### AWS 권한
다음 AWS 서비스에 대한 권한이 필요합니다:
- **DynamoDB** (테이블 생성/관리)
- **Lambda** (함수 생성/관리)
- **API Gateway** (REST API 생성/관리)
- **ECS** (클러스터/서비스 생성/관리)
- **ECR** (리포지토리 생성/관리)
- **VPC** (네트워크 리소스 생성/관리)
- **ALB** (로드밸런서 생성/관리)
- **IAM** (역할/정책 생성/관리)
- **CloudWatch** (메트릭/알람/대시보드 생성/관리)
- **X-Ray** (트레이싱 설정)

## 🚀 배포 단계

### 1단계: 환경 설정

```bash
# 저장소 클론
git clone https://github.com/amazon-q-developer-hackathon-q4mo/team13-aws-hackathon.git
cd team13-aws-hackathon

# AWS CLI 설정 확인
aws configure list
aws sts get-caller-identity

# 리전 설정 (us-east-1 권장)
export AWS_DEFAULT_REGION=us-east-1
```

### 2단계: Terraform 초기화

```bash
cd infrastructure

# Terraform 초기화
terraform init

# 배포 계획 확인
terraform plan

# 변수 파일 확인 (필요시 수정)
cat terraform.tfvars
```

### 3단계: 인프라 배포

#### Phase 1-5: DynamoDB 인프라
```bash
# DynamoDB 인프라 배포
cd infrastructure
terraform init
terraform apply -auto-approve
```

#### Phase 6: 웹 애플리케이션 인프라
```bash
# ECS Fargate 인프라 배포
cd web-app
terraform init
terraform apply -auto-approve
```

#### Phase 7: 고급 모니터링 인프라
```bash
# 모니터링 인프라 배포
cd ../monitoring
terraform init
terraform apply -auto-approve
```

#### 통합 배포 (권장)
```bash
# 전체 자동 배포
cd ../../
chmod +x scripts/deploy.sh
./scripts/deploy.sh

# 블루-그린 배포
./scripts/blue-green-deploy.sh
```

### 4단계: 배포 검증

#### 기본 검증
```bash
# DynamoDB 인프라 상태 확인
cd infrastructure
terraform output

# 웹 애플리케이션 상태 확인
cd web-app
terraform output

# ALB DNS 이름 확인
ALB_DNS=$(terraform output -raw alb_dns_name)
echo "Application URL: http://$ALB_DNS"
```

#### Phase 7 통합 테스트
```bash
# 통합 테스트 실행
cd ../../
./scripts/run-tests.sh all

# 개별 테스트 실행
./scripts/run-tests.sh e2e "http://$ALB_DNS" "$(cd infrastructure && terraform output -raw api_gateway_url)"
./scripts/run-tests.sh performance "http://$ALB_DNS" "$(cd infrastructure && terraform output -raw api_gateway_url)"
```

#### 헬스체크
```bash
# Django 애플리케이션 헬스체크
curl -f "http://$ALB_DNS/health/"

# API 엔드포인트 테스트
curl "http://$ALB_DNS/api/sessions/active/"
```

## 📊 배포되는 리소스

### Phase 1-5: DynamoDB 인프라

### DynamoDB 테이블 (3개)
```
LiveInsight-Events
├── PK: event_id (String)
├── SK: timestamp (Number)
├── GSI: UserIndex (user_id, timestamp)
└── GSI: SessionIndex (session_id, timestamp)

LiveInsight-Sessions
├── PK: session_id (String)
└── GSI: UserIndex (user_id, start_time)

LiveInsight-ActiveSessions
├── PK: session_id (String)
└── TTL: expires_at (30분)
```

### Lambda 함수 (1개)
```
LiveInsight-EventCollector
├── Runtime: Python 3.9
├── Memory: 512MB
├── Timeout: 30초
├── Environment Variables:
│   ├── EVENTS_TABLE=LiveInsight-Events
│   ├── SESSIONS_TABLE=LiveInsight-Sessions
│   └── ACTIVE_SESSIONS_TABLE=LiveInsight-ActiveSessions
└── X-Ray Tracing: Active
```

### API Gateway (1개)
```
LiveInsight-API
├── Type: REST API
├── Stage: prod
├── Endpoint: /events (POST, OPTIONS)
├── CORS: Enabled
└── Integration: Lambda Proxy
```

### Phase 6: 웹 애플리케이션 인프라
```
ECS Fargate:
├── Cluster: liveinsight-cluster
├── Service: liveinsight-service (1-4 tasks)
├── Task Definition: Django 애플리케이션
└── Auto Scaling: CPU 기반 (70% 임계값)

Networking:
├── VPC: 10.0.0.0/16
├── Public Subnets: 2개 (ALB용)
├── Private Subnets: 2개 (ECS용)
├── NAT Gateway: 2개
└── Internet Gateway: 1개

Load Balancer:
├── ALB: liveinsight-alb
├── Target Group: liveinsight-tg
├── Health Check: /health/
└── Listener: HTTP:80

Container Registry:
├── ECR Repository: liveinsight-app
├── Image Scanning: Enabled
└── Lifecycle Policy: 최근 10개 이미지 유지
```

### Phase 7: 고급 모니터링 인프라
```
CloudWatch Advanced:
├── Custom Metrics:
│   ├── LiveInsight/EventsProcessed
│   └── LiveInsight/ProcessingTime
├── Business Dashboard: 비즈니스 메트릭
├── Advanced Alarms:
│   ├── API Error Rate (>10 errors/5min)
│   ├── High Response Time (>500ms)
│   ├── Lambda Duration (>5s)
│   └── Predictive Scaling (>1000 req/5min)
└── Log Metric Filters: 자동 메트릭 생성

X-Ray Tracing:
├── Sampling Rate: 10%
├── Service Map: 활성화
└── Trace Analysis: 활성화

Caching:
├── Django Local Memory Cache
├── Active Sessions Cache: 30초
└── Statistics Cache: 10분
```

## 🔧 환경별 배포

### Phase 7 성능 최적화 설정

### 개발 환경
```bash
# 개발용 변수 설정
cat > terraform.tfvars << EOF
aws_region = "us-east-1"
environment = "development"
project_name = "LiveInsight-Dev"
# Phase 7 최적화 설정
cache_enabled = true
monitoring_level = "basic"
EOF

# 개발 환경 배포
./scripts/deploy.sh

# 개발 서버 실행 (로컬)
./scripts/dev.sh native
```

### 프로덕션 환경
```bash
# 프로덕션용 변수 설정
cat > terraform.tfvars << EOF
aws_region = "us-east-1"
environment = "production"
project_name = "LiveInsight"
# Phase 7 최적화 설정
cache_enabled = true
monitoring_level = "advanced"
x_ray_tracing = true
auto_scaling_enabled = true
EOF

# 블루-그린 배포 (프로덕션 권장)
./scripts/blue-green-deploy.sh
```

## 📝 배포 후 설정

### 1. API Gateway URL 확인
```bash
# API Gateway URL 출력
terraform output api_gateway_url

# 환경 변수로 저장
export API_GATEWAY_URL=$(terraform output -raw api_gateway_url)
echo "API Gateway URL: $API_GATEWAY_URL"
```

### 2. CloudWatch 대시보드 설정
```bash
# 대시보드 URL 생성
echo "CloudWatch Dashboard: https://console.aws.amazon.com/cloudwatch/home?region=$AWS_DEFAULT_REGION#dashboards:"
```

### 3. Phase 7 모니터링 설정
```bash
# CloudWatch 대시보드 URL
echo "Business Dashboard: https://console.aws.amazon.com/cloudwatch/home?region=$AWS_DEFAULT_REGION#dashboards:name=LiveInsight-BusinessMetrics"

# X-Ray 서비스 맵
echo "X-Ray Service Map: https://console.aws.amazon.com/xray/home?region=$AWS_DEFAULT_REGION#/service-map"

# 캐시 상태 확인
curl "http://$(cd infrastructure/web-app && terraform output -raw alb_dns_name)/api/sessions/active/" -w "Response Time: %{time_total}s\n"
```

### 4. 개발자 B 연동 정보
```bash
# 연동 정보 출력
echo "=== 개발자 B 연동 정보 ==="
echo "Django Application URL: http://$(cd infrastructure/web-app && terraform output -raw alb_dns_name)"
echo "API Gateway URL: $(cd infrastructure && terraform output -raw api_gateway_url)"
echo "Events Table: $(cd infrastructure && terraform output -raw events_table_name)"
echo "Sessions Table: $(cd infrastructure && terraform output -raw sessions_table_name)"
echo "ActiveSessions Table: $(cd infrastructure && terraform output -raw active_sessions_table_name)"
```

## 🧪 배포 검증

### Phase 7 통합 테스트 실행
```bash
# 테스트 스크립트 실행 권한 부여
chmod +x scripts/*.sh

# 전체 통합 테스트
./scripts/run-tests.sh all

# E2E 테스트
./scripts/run-tests.sh e2e

# 성능 테스트
./scripts/run-tests.sh performance

# 로컬 Django 테스트
./scripts/test.sh local

# 배포된 애플리케이션 테스트
./scripts/test.sh deployment
```

### 수동 검증
```bash
# 1. DynamoDB 테이블 상태 확인
aws dynamodb list-tables --query 'TableNames[?contains(@, `LiveInsight`)]'

# 2. Lambda 함수 상태 확인
aws lambda get-function --function-name LiveInsight-EventCollector

# 3. ECS 서비스 상태 확인
aws ecs describe-services --cluster liveinsight-cluster --services liveinsight-service

# 4. ALB 헬스체크 확인
ALB_DNS=$(cd infrastructure/web-app && terraform output -raw alb_dns_name)
curl -f "http://$ALB_DNS/health/"

# 5. Django API 테스트
curl "http://$ALB_DNS/api/sessions/active/"
curl "http://$ALB_DNS/api/statistics/hourly/"

# 6. 캐시 성능 테스트
time curl "http://$ALB_DNS/api/sessions/active/" # 첫 번째 요청
time curl "http://$ALB_DNS/api/sessions/active/" # 캐시된 요청

# 7. CloudWatch 메트릭 확인
aws cloudwatch list-metrics --namespace LiveInsight
aws cloudwatch list-metrics --namespace AWS/ECS
aws cloudwatch list-metrics --namespace AWS/ApplicationELB

# 8. X-Ray 트레이스 확인
aws xray get-service-graph --start-time $(date -d '1 hour ago' +%s) --end-time $(date +%s)
```

## 🔄 업데이트 및 재배포

### Django 애플리케이션 업데이트
```bash
# 일반 배포
./scripts/deploy.sh

# 블루-그린 배포 (무중단)
./scripts/blue-green-deploy.sh

# 특정 이미지 태그로 배포
./scripts/blue-green-deploy.sh v1.2.0
```

### Lambda 함수 코드 업데이트
```bash
# Lambda 함수 코드만 업데이트
cd infrastructure
zip -f lambda_function.zip lambda_function.py
aws lambda update-function-code \
  --function-name LiveInsight-EventCollector \
  --zip-file fileb://lambda_function.zip
```

### 인프라 업데이트
```bash
# Terraform으로 인프라 업데이트
terraform plan
terraform apply
```

### 롤백
```bash
# ECS 서비스 롤백 (자동)
./scripts/rollback.sh

# Lambda 함수 롤백
cd infrastructure
chmod +x rollback.sh
./rollback.sh

# Terraform으로 특정 리소스 롤백
terraform apply -target=aws_lambda_function.event_collector
terraform apply -target=aws_ecs_service.app
```

## 🗑️ 리소스 삭제

### 전체 삭제
```bash
# Terraform으로 모든 리소스 삭제
terraform destroy -auto-approve

# 확인
aws dynamodb list-tables --query 'TableNames[?contains(@, `LiveInsight`)]'
```

### 선택적 삭제
```bash
# 특정 리소스만 삭제
terraform destroy -target=aws_dynamodb_table.events
terraform destroy -target=aws_lambda_function.event_collector
```

## 💰 비용 최적화

### 예상 비용 (월간) - Phase 7 포함
```
Phase 1-5: DynamoDB 인프라
├── DynamoDB (프로비저닝 모드): ~$12
├── Lambda (100만 요청): ~$2.20
└── API Gateway (100만 요청): ~$3.50
소계: ~$18/월

Phase 6: 웹 애플리케이션 인프라
├── ECS Fargate (1 태스크): ~$15
├── ALB: ~$20
├── NAT Gateway (2개): ~$32
├── ECR 스토리지: ~$2
└── 기본 CloudWatch: ~$5
소계: ~$74/월

Phase 7: 고급 모니터링
├── 고급 CloudWatch 메트릭: ~$10
├── X-Ray 트레이싱: ~$5
└── 추가 로그 스토리지: ~$3
소계: ~$18/월

총 예상 비용: ~$110/월 (전체 시스템)
```

### 비용 절약 방법
```bash
# DynamoDB On-Demand 모드로 변경
terraform apply -var="billing_mode=PAY_PER_REQUEST"

# ECS 태스크 수 조정 (개발 환경)
terraform apply -var="ecs_desired_count=1"

# NAT Gateway 1개로 축소 (개발 환경)
terraform apply -var="nat_gateway_count=1"

# CloudWatch 로그 보존 기간 단축
terraform apply -var="log_retention_days=7"

# X-Ray 샘플링 비율 조정
terraform apply -var="xray_sampling_rate=0.05"
```

## 🚨 트러블슈팅

### 일반적인 문제

#### 1. Terraform 초기화 실패
```bash
# 해결방법
rm -rf .terraform
terraform init
```

#### 2. IAM 권한 부족
```bash
# 필요한 권한 확인
aws iam simulate-principal-policy \
  --policy-source-arn $(aws sts get-caller-identity --query Arn --output text) \
  --action-names dynamodb:CreateTable lambda:CreateFunction
```

#### 3. Lambda 배포 실패
```bash
# 로그 확인
aws logs describe-log-groups --log-group-name-prefix /aws/lambda/LiveInsight

# 함수 상태 확인
aws lambda get-function --function-name LiveInsight-EventCollector
```

#### 4. ECS 서비스 시작 실패
```bash
# ECS 서비스 상태 확인
aws ecs describe-services --cluster liveinsight-cluster --services liveinsight-service

# 태스크 로그 확인
aws logs filter-log-events \
  --log-group-name /ecs/liveinsight \
  --start-time $(date -d '1 hour ago' +%s)000
```

#### 5. ALB 헬스체크 실패
```bash
# 타겟 그룹 상태 확인
aws elbv2 describe-target-health --target-group-arn $(cd infrastructure/web-app && terraform output -raw target_group_arn)

# Django 헬스체크 엔드포인트 테스트
curl -v "http://$(cd infrastructure/web-app && terraform output -raw alb_dns_name)/health/"
```

#### 6. 캐시 성능 문제
```bash
# Django 캐시 상태 확인
cd src
python manage.py shell -c "from django.core.cache import cache; print(cache.get('active_sessions'))"

# 캐시 통계 확인
curl "http://$(cd ../infrastructure/web-app && terraform output -raw alb_dns_name)/api/sessions/active/" -w "Time: %{time_total}s\n"
```

#### 7. API Gateway 5xx 에러
```bash
# Lambda 로그 확인
aws logs filter-log-events \
  --log-group-name /aws/lambda/LiveInsight-EventCollector \
  --start-time $(date -d '1 hour ago' +%s)000

# X-Ray 트레이스 확인
aws xray get-trace-summaries \
  --time-range-type TimeRangeByStartTime \
  --start-time $(date -d '1 hour ago' +%s) \
  --end-time $(date +%s)
```

## 📞 지원 및 문의

### 문서 참조
- [AWS Lambda 개발자 가이드](https://docs.aws.amazon.com/lambda/)
- [Amazon DynamoDB 개발자 가이드](https://docs.aws.amazon.com/dynamodb/)
- [Amazon API Gateway 개발자 가이드](https://docs.aws.amazon.com/apigateway/)

### 로그 및 모니터링
- **CloudWatch 로그**: `/aws/lambda/LiveInsight-EventCollector`
- **CloudWatch 메트릭**: `LiveInsight` 네임스페이스
- **X-Ray 트레이싱**: Lambda 함수에서 활성화됨

이 배포 가이드를 따라하면 LiveInsight 인프라를 성공적으로 배포하고 운영할 수 있습니다.