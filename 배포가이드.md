# LiveInsight 배포 가이드

## 📋 배포 개요

LiveInsight는 AWS 서버리스 아키텍처를 기반으로 한 실시간 웹사이트 사용자 행동 분석 서비스입니다. 이 가이드는 전체 인프라를 처음부터 배포하는 방법을 설명합니다.

## 🏗️ 아키텍처 다이어그램

```
┌─────────────┐    ┌──────────────┐    ┌─────────────┐    ┌──────────────┐
│   웹사이트   │───▶│ API Gateway  │───▶│   Lambda    │───▶│  DynamoDB    │
│ (JS 추적)   │    │              │    │ EventCollector│    │   Tables     │
└─────────────┘    └──────────────┘    └─────────────┘    └──────────────┘
                           │                    │                   │
                           │                    ▼                   │
                           │            ┌─────────────┐             │
                           │            │ CloudWatch  │             │
                           │            │ Monitoring  │             │
                           │            └─────────────┘             │
                           │                                        │
                           ▼                                        ▼
                   ┌──────────────┐                        ┌──────────────┐
                   │ Django API   │◀───────────────────────│ ActiveSessions│
                   │ (개발자 B)   │                        │   (TTL 30분)  │
                   └──────────────┘                        └──────────────┘
```

## 🛠️ 사전 요구사항

### 필수 도구
- **AWS CLI** (v2.0+)
- **Terraform** (v1.0+)
- **Python** (3.9+)
- **Git**

### AWS 권한
다음 AWS 서비스에 대한 권한이 필요합니다:
- DynamoDB (테이블 생성/관리)
- Lambda (함수 생성/관리)
- API Gateway (REST API 생성/관리)
- IAM (역할/정책 생성/관리)
- CloudWatch (메트릭/알람 생성/관리)

## 🚀 배포 단계

### 1단계: 환경 설정

```bash
# 저장소 클론
git clone https://github.com/amazon-q-developer-hackathon-q4mo/team13-aws-hackathon.git
cd team13-aws-hackathon

# AWS CLI 설정 확인
aws configure list
aws sts get-caller-identity

# 리전 설정 (us-east-1 권장)
export AWS_DEFAULT_REGION=us-east-1
```

### 2단계: Terraform 초기화

```bash
cd infrastructure

# Terraform 초기화
terraform init

# 배포 계획 확인
terraform plan

# 변수 파일 확인 (필요시 수정)
cat terraform.tfvars
```

### 3단계: 인프라 배포

```bash
# 자동 배포 스크립트 실행
chmod +x deploy.sh
./deploy.sh

# 또는 수동 배포
terraform apply -auto-approve
```

### 4단계: 배포 검증

```bash
# 배포 상태 확인
terraform output

# API 테스트
curl -X POST $(terraform output -raw api_gateway_url)/events \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "deploy_test",
    "event_type": "page_view",
    "page_url": "https://example.com/test"
  }'
```

## 📊 배포되는 리소스

### DynamoDB 테이블 (3개)
```
LiveInsight-Events
├── PK: event_id (String)
├── SK: timestamp (Number)
├── GSI: UserIndex (user_id, timestamp)
└── GSI: SessionIndex (session_id, timestamp)

LiveInsight-Sessions
├── PK: session_id (String)
└── GSI: UserIndex (user_id, start_time)

LiveInsight-ActiveSessions
├── PK: session_id (String)
└── TTL: expires_at (30분)
```

### Lambda 함수 (1개)
```
LiveInsight-EventCollector
├── Runtime: Python 3.9
├── Memory: 512MB
├── Timeout: 30초
├── Environment Variables:
│   ├── EVENTS_TABLE=LiveInsight-Events
│   ├── SESSIONS_TABLE=LiveInsight-Sessions
│   └── ACTIVE_SESSIONS_TABLE=LiveInsight-ActiveSessions
└── X-Ray Tracing: Active
```

### API Gateway (1개)
```
LiveInsight-API
├── Type: REST API
├── Stage: prod
├── Endpoint: /events (POST, OPTIONS)
├── CORS: Enabled
└── Integration: Lambda Proxy
```

### CloudWatch 모니터링
```
Custom Metrics:
├── LiveInsight/EventsProcessed
└── LiveInsight/ProcessingTime

Alarms:
├── LiveInsight-Lambda-ErrorRate
├── LiveInsight-Lambda-Duration
└── LiveInsight-DynamoDB-Throttles
```

## 🔧 환경별 배포

### 개발 환경
```bash
# 개발용 변수 설정
cat > terraform.tfvars << EOF
aws_region = "us-east-1"
environment = "development"
project_name = "LiveInsight-Dev"
EOF

terraform apply -var-file=terraform.tfvars
```

### 프로덕션 환경
```bash
# 프로덕션용 변수 설정
cat > terraform.tfvars << EOF
aws_region = "us-east-1"
environment = "production"
project_name = "LiveInsight"
EOF

terraform apply -var-file=terraform.tfvars
```

## 📝 배포 후 설정

### 1. API Gateway URL 확인
```bash
# API Gateway URL 출력
terraform output api_gateway_url

# 환경 변수로 저장
export API_GATEWAY_URL=$(terraform output -raw api_gateway_url)
echo "API Gateway URL: $API_GATEWAY_URL"
```

### 2. CloudWatch 대시보드 설정
```bash
# 대시보드 URL 생성
echo "CloudWatch Dashboard: https://console.aws.amazon.com/cloudwatch/home?region=$AWS_DEFAULT_REGION#dashboards:"
```

### 3. 개발자 B 연동 정보
```bash
# 연동 정보 출력
echo "=== 개발자 B 연동 정보 ==="
echo "API Gateway URL: $(terraform output -raw api_gateway_url)"
echo "Events Table: $(terraform output -raw events_table_name)"
echo "Sessions Table: $(terraform output -raw sessions_table_name)"
echo "ActiveSessions Table: $(terraform output -raw active_sessions_table_name)"
```

## 🧪 배포 검증

### 자동 테스트 실행
```bash
# 테스트 스크립트 실행 권한 부여
chmod +x ../테스트가이드.md의 스크립트들

# 전체 시스템 테스트
python3 api_test.py
python3 dynamodb_test.py
python3 monitoring_test.py
```

### 수동 검증
```bash
# 1. DynamoDB 테이블 상태 확인
aws dynamodb list-tables --query 'TableNames[?contains(@, `LiveInsight`)]'

# 2. Lambda 함수 상태 확인
aws lambda get-function --function-name LiveInsight-EventCollector

# 3. API Gateway 테스트
curl -X OPTIONS $API_GATEWAY_URL/events
curl -X POST $API_GATEWAY_URL/events \
  -H "Content-Type: application/json" \
  -d '{"user_id":"test","event_type":"page_view","page_url":"https://example.com"}'

# 4. CloudWatch 메트릭 확인
aws cloudwatch list-metrics --namespace LiveInsight
```

## 🔄 업데이트 및 재배포

### 코드 업데이트
```bash
# Lambda 함수 코드만 업데이트
zip -f lambda_function.zip lambda_function.py
aws lambda update-function-code \
  --function-name LiveInsight-EventCollector \
  --zip-file fileb://lambda_function.zip
```

### 인프라 업데이트
```bash
# Terraform으로 인프라 업데이트
terraform plan
terraform apply
```

### 롤백
```bash
# 롤백 스크립트 실행
chmod +x rollback.sh
./rollback.sh

# 또는 Terraform으로 이전 상태 복원
terraform apply -target=aws_lambda_function.event_collector
```

## 🗑️ 리소스 삭제

### 전체 삭제
```bash
# Terraform으로 모든 리소스 삭제
terraform destroy -auto-approve

# 확인
aws dynamodb list-tables --query 'TableNames[?contains(@, `LiveInsight`)]'
```

### 선택적 삭제
```bash
# 특정 리소스만 삭제
terraform destroy -target=aws_dynamodb_table.events
terraform destroy -target=aws_lambda_function.event_collector
```

## 💰 비용 최적화

### 예상 비용 (월간)
```
DynamoDB (프로비저닝 모드):
├── 읽기 용량 5 유닛 × 3 테이블 = ~$6
└── 쓰기 용량 5 유닛 × 3 테이블 = ~$6

Lambda:
├── 요청 100만건 = ~$0.20
└── 실행 시간 (512MB, 134ms) = ~$2

API Gateway:
└── 요청 100만건 = ~$3.50

총 예상 비용: ~$18/월 (100만 요청 기준)
```

### 비용 절약 방법
```bash
# DynamoDB On-Demand 모드로 변경 (트래픽이 불규칙한 경우)
terraform apply -var="billing_mode=PAY_PER_REQUEST"

# Lambda 메모리 최적화 (사용량에 따라 256MB로 조정)
terraform apply -var="lambda_memory=256"
```

## 🚨 트러블슈팅

### 일반적인 문제

#### 1. Terraform 초기화 실패
```bash
# 해결방법
rm -rf .terraform
terraform init
```

#### 2. IAM 권한 부족
```bash
# 필요한 권한 확인
aws iam simulate-principal-policy \
  --policy-source-arn $(aws sts get-caller-identity --query Arn --output text) \
  --action-names dynamodb:CreateTable lambda:CreateFunction
```

#### 3. Lambda 배포 실패
```bash
# 로그 확인
aws logs describe-log-groups --log-group-name-prefix /aws/lambda/LiveInsight

# 함수 상태 확인
aws lambda get-function --function-name LiveInsight-EventCollector
```

#### 4. API Gateway 5xx 에러
```bash
# CloudWatch 로그 확인
aws logs filter-log-events \
  --log-group-name /aws/lambda/LiveInsight-EventCollector \
  --start-time $(date -d '1 hour ago' +%s)000
```

## 📞 지원 및 문의

### 문서 참조
- [AWS Lambda 개발자 가이드](https://docs.aws.amazon.com/lambda/)
- [Amazon DynamoDB 개발자 가이드](https://docs.aws.amazon.com/dynamodb/)
- [Amazon API Gateway 개발자 가이드](https://docs.aws.amazon.com/apigateway/)

### 로그 및 모니터링
- **CloudWatch 로그**: `/aws/lambda/LiveInsight-EventCollector`
- **CloudWatch 메트릭**: `LiveInsight` 네임스페이스
- **X-Ray 트레이싱**: Lambda 함수에서 활성화됨

이 배포 가이드를 따라하면 LiveInsight 인프라를 성공적으로 배포하고 운영할 수 있습니다.