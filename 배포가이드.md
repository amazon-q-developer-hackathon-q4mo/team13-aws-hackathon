# LiveInsight 배포 가이드

## 📋 배포 개요

LiveInsight는 AWS 서버리스 아키텍처를 기반으로 한 실시간 웹사이트 사용자 행동 분석 서비스입니다. 이 가이드는 Terraform을 사용하여 전체 인프라를 배포하는 방법을 설명합니다.

## 🛠️ 사전 요구사항

### 필수 도구
- **AWS CLI** (v2.0+) - 설정 완료 필수
- **Terraform** (v1.0+) - 인프라 배포용
- **Docker** (20.0+) - 이미지 빌드용
- **Python** (3.11+) - Django 애플리케이션

### AWS 권한
다음 AWS 서비스에 대한 권한이 필요합니다:
- DynamoDB, Lambda, API Gateway
- ECS, ECR, VPC, ALB
- IAM, CloudWatch, X-Ray

## 🚀 빠른 시작

### 1. 환경 준비
```bash
# AWS CLI 설정 확인
aws configure list
aws sts get-caller-identity
```

### 2. 전체 인프라 배포
```bash
# 프로젝트 루트에서 실행
cd infrastructure

# Terraform 초기화
terraform init

# 배포 계획 확인
terraform plan

# 전체 인프라 배포
terraform apply
```

### 3. 애플리케이션 배포
```bash
# 프로젝트 루트로 이동
cd ..

# Docker 이미지 빌드 및 배포
./scripts/build.sh

# ECS 서비스 업데이트
aws ecs update-service --cluster LiveInsight-cluster --service LiveInsight-service --force-new-deployment
```

### 4. 배포 검증
```bash
# 리소스 상태 확인
cd infrastructure
terraform output

# 헬스체크
ALB_DNS=$(terraform output -raw web_app_url | sed 's|http://||')
curl "http://$ALB_DNS/health/"
```

## 📊 배포된 리소스

### 서버리스 백엔드
- **DynamoDB 테이블**: Events, Sessions, ActiveSessions
- **Lambda 함수**: EventCollector (이벤트 수집 및 처리)
- **API Gateway**: REST API (/events 엔드포인트)

### 웹 애플리케이션
- **ECS Fargate**: Django 애플리케이션 (Auto Scaling)
- **ALB**: Application Load Balancer
- **VPC**: 네트워크 인프라 (Public/Private Subnets)
- **ECR**: Docker 이미지 레지스트리

### 모니터링
- **CloudWatch**: 메트릭, 알람, 대시보드
- **X-Ray**: 분산 트레이싱

## 🔧 환경별 배포

### 개발 환경
```bash
# terraform.tfvars 설정
cat > infrastructure/terraform.tfvars << EOF
aws_region = "us-east-1"
environment = "development"
project_name = "LiveInsight-Dev"
EOF

# 배포
cd infrastructure
terraform apply
```

### 프로덕션 환경
```bash
# terraform.tfvars 설정
cat > infrastructure/terraform.tfvars << EOF
aws_region = "us-east-1"
environment = "production"
project_name = "LiveInsight"
EOF

# 블루-그린 배포
./scripts/blue-green-deploy.sh
```

## 📝 배포 후 설정

### 서비스 URL 확인
```bash
cd infrastructure
terraform output
```

### 주요 엔드포인트
- **웹 애플리케이션**: Terraform output의 `web_app_url`
- **API Gateway**: Terraform output의 `api_gateway_url`
- **CloudWatch 대시보드**: AWS 콘솔에서 확인

## 🧪 배포 검증

### 자동 테스트
```bash
# 통합 테스트
./scripts/run-tests.sh

# 배포 검증
./scripts/test.sh deployment
```

### 수동 검증
```bash
# DynamoDB 테이블 확인
aws dynamodb list-tables --query 'TableNames[?contains(@, `LiveInsight`)]'

# Lambda 함수 확인
aws lambda get-function --function-name LiveInsight-EventCollector

# ECS 서비스 확인
aws ecs describe-services --cluster LiveInsight-cluster --services LiveInsight-service

# 헬스체크
ALB_DNS=$(cd infrastructure && terraform output -raw web_app_url | sed 's|http://||')
curl "http://$ALB_DNS/health/"
```

## 🔄 업데이트 및 재배포

### 애플리케이션 업데이트
```bash
# 일반 배포
./scripts/build.sh
aws ecs update-service --cluster LiveInsight-cluster --service LiveInsight-service --force-new-deployment

# 블루-그린 배포
./scripts/blue-green-deploy.sh
```

### 인프라 업데이트
```bash
cd infrastructure
terraform plan
terraform apply
```

### 롤백
```bash
./scripts/rollback.sh
```

## 🗑️ 리소스 삭제

```bash
cd infrastructure
terraform destroy
```

## 💰 예상 비용 (월간)

### 기본 구성
- **DynamoDB**: ~$12 (프로비저닝 모드)
- **Lambda**: ~$2.20 (100만 요청)
- **API Gateway**: ~$3.50 (100만 요청)
- **ECS Fargate**: ~$15 (1 태스크)
- **ALB**: ~$20
- **NAT Gateway**: ~$32 (2개)
- **CloudWatch**: ~$5

**총 예상 비용**: ~$90/월

### 비용 절약
```bash
# DynamoDB On-Demand 모드
terraform apply -var="billing_mode=PAY_PER_REQUEST"

# 개발 환경 최적화
terraform apply -var="ecs_desired_count=1" -var="nat_gateway_count=1"
```

## 🚨 트러블슈팅

### 일반적인 문제

#### Terraform 초기화 실패
```bash
rm -rf .terraform
terraform init
```

#### Docker 플랫폼 문제 (ARM Mac)
```bash
# build.sh 스크립트가 자동으로 linux/amd64 플랫폼으로 빌드
cd src
docker build --platform linux/amd64 -t liveinsight:latest .
```

#### ECS 서비스 시작 실패
```bash
# 서비스 상태 확인
aws ecs describe-services --cluster LiveInsight-cluster --services LiveInsight-service

# 로그 확인
aws logs filter-log-events --log-group-name /ecs/LiveInsight
```

#### Lambda 배포 실패
```bash
# 함수 상태 확인
aws lambda get-function --function-name LiveInsight-EventCollector

# 로그 확인
aws logs describe-log-groups --log-group-name-prefix /aws/lambda/LiveInsight
```

## 📞 지원

### 로그 위치
- **Lambda 로그**: `/aws/lambda/LiveInsight-EventCollector`
- **ECS 로그**: `/ecs/LiveInsight`
- **CloudWatch 메트릭**: `LiveInsight` 네임스페이스