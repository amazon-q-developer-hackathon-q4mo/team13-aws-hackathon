# LiveInsight 배포 가이드

## 📋 배포 개요

LiveInsight는 AWS 서버리스 아키텍처를 기반으로 한 실시간 웹사이트 사용자 행동 분석 서비스입니다. 이 가이드는 전체 인프라를 처음부터 배포하는 방법을 설명합니다.

## 🏗️ 아키텍처 다이어그램

```
┌─────────────┐    ┌──────────────┐    ┌─────────────┐    ┌──────────────┐
│   웹사이트   │───▶│ API Gateway  │───▶│   Lambda    │───▶│  DynamoDB    │
│ (JS 추적)   │    │              │    │ EventCollector│    │   Tables     │
└─────────────┘    └──────────────┘    └─────────────┘    └──────────────┘
                           │                    │                   │
                           │                    ▼                   │
                           │            ┌─────────────┐             │
                           │            │ CloudWatch  │             │
                           │            │ Monitoring  │             │
                           │            │ + X-Ray     │             │
                           │            └─────────────┘             │
                           │                                        │
                           ▼                                        ▼
                   ┌──────────────┐                        ┌──────────────┐
                   │ Django API   │◀───────────────────────│ ActiveSessions│
                   │ (ECS Fargate)│                        │   (TTL 30분)  │
                   │ + 캐시 최적화 │                        │              │
                   └──────────────┘                        └──────────────┘
                           │
                           ▼
                   ┌──────────────┐
                   │     ALB      │
                   │ (Load Balancer)│
                   └──────────────┘
```

## 🛠️ 사전 요구사항

### 필수 도구
- **AWS CLI** (v2.0+) - 설정 완료 필수
- **Terraform** (v1.0+) - 인프라 배포용
- **Docker** (20.0+) - 이미지 빌드용
- **Python** (3.11+) - Django 애플리케이션
- **curl** - API 테스트용

### AWS 권한
다음 AWS 서비스에 대한 권한이 필요합니다:
- **DynamoDB** (테이블 생성/관리)
- **Lambda** (함수 생성/관리)
- **API Gateway** (REST API 생성/관리)
- **ECS** (클러스터/서비스 생성/관리)
- **ECR** (리포지토리 생성/관리)
- **VPC** (네트워크 리소스 생성/관리)
- **ALB** (로드밸런서 생성/관리)
- **IAM** (역할/정책 생성/관리)
- **CloudWatch** (메트릭/알람/대시보드 생성/관리)
- **X-Ray** (트레이싱 설정)

## 🚀 배포 단계

### 1단계: 환경 준비

```bash
# 현재 디렉토리 확인
pwd

# AWS CLI 설정 확인
aws configure list
aws sts get-caller-identity

# 리전 설정 확인
echo $AWS_DEFAULT_REGION
```

### 2단계: Phase 1-5 (서버리스 인프라) 배포

```bash
cd infrastructure

# Terraform 초기화
terraform init

# 배포 계획 확인
terraform plan

# Phase 1-5 인프라 배포
terraform apply -auto-approve
```

### 3단계: Django 애플리케이션 빌드 및 배포

```bash
# 프로젝트 루트로 이동
cd ..

# Docker 이미지 빌드 및 ECR 푸시
bash scripts/build.sh

# ECS 서비스 강제 업데이트
aws ecs update-service --cluster LiveInsight-cluster --service LiveInsight-service --force-new-deployment --region us-east-1
```

### 4단계: Phase 7 (고급 모니터링) 배포

```bash
# infrastructure 디렉토리로 이동
cd infrastructure

# 모니터링 모듈 초기화 및 배포
terraform init
terraform apply -auto-approve
```

### 5단계: 배포 검증

#### 기본 검증
```bash
# 전체 리소스 상태 확인
cd infrastructure
terraform output

# ECS 서비스 상태 확인
aws ecs describe-services --cluster LiveInsight-cluster --services LiveInsight-service --query 'services[0].{Name:serviceName,Status:status,Running:runningCount,Desired:desiredCount}' --output table

# DynamoDB 테이블 확인
aws dynamodb list-tables --query 'TableNames[?contains(@, `LiveInsight`)]' --output table
```

#### 애플리케이션 헬스체크
```bash
# ALB DNS 이름 확인
ALB_DNS="LiveInsight-alb-552300943.us-east-1.elb.amazonaws.com"

# Django 애플리케이션 헬스체크 (서비스 시작 후)
curl -f "http://$ALB_DNS/health/" || echo "Service starting - wait a few minutes"

# API 엔드포인트 테스트
curl "http://$ALB_DNS/api/sessions/active/"
```

## 📊 배포된 리소스

### Phase 1-5: 서버리스 인프라 (완료)

**DynamoDB 테이블 (3개)**
- LiveInsight-Events: 이벤트 데이터 저장
- LiveInsight-Sessions: 세션 데이터 저장  
- LiveInsight-ActiveSessions: 활성 세션 (TTL 30분)

**Lambda 함수 (1개)**
- LiveInsight-EventCollector: 이벤트 수집 및 처리

**API Gateway (1개)**
- LiveInsight-API: REST API (/events 엔드포인트)

### Phase 6: 웹 애플리케이션 (완료)

**ECS Fargate**
- Cluster: LiveInsight-cluster
- Service: LiveInsight-service
- Task Definition: Django 애플리케이션
- Auto Scaling: 1-4 tasks (CPU 70% 임계값)

**네트워킹**
- VPC: 10.0.0.0/16
- Public Subnets: 2개 (ALB용)
- Private Subnets: 2개 (ECS용)
- NAT Gateway: 2개
- ALB: LiveInsight-alb

**컨테이너 레지스트리**
- ECR Repository: liveinsight-app
- Docker 이미지: 빌드 및 푸시 완료

### Phase 7: 고급 모니터링 (완료)

**CloudWatch 고급 모니터링**
- 비즈니스 메트릭 대시보드
- 고급 알람 8개 (API 오류율, 응답시간, Lambda 지속시간 등)
- 커스텀 로그 메트릭 필터

**X-Ray 트레이싱**
- 샘플링 비율: 10%
- 서비스 맵 활성화

## 🔧 환경별 배포

### Phase 7 성능 최적화 설정

### 개발 환경
```bash
# 개발용 변수 설정
cat > terraform.tfvars << EOF
aws_region = "us-east-1"
environment = "development"
project_name = "LiveInsight-Dev"
# Phase 7 최적화 설정
cache_enabled = true
monitoring_level = "basic"
EOF

# 개발 환경 배포
./scripts/deploy.sh

# 개발 서버 실행 (로컬)
./scripts/dev.sh native
```

### 프로덕션 환경
```bash
# 프로덕션용 변수 설정
cat > terraform.tfvars << EOF
aws_region = "us-east-1"
environment = "production"
project_name = "LiveInsight"
# Phase 7 최적화 설정
cache_enabled = true
monitoring_level = "advanced"
x_ray_tracing = true
auto_scaling_enabled = true
EOF

# 블루-그린 배포 (프로덕션 권장)
./scripts/blue-green-deploy.sh

# Phase 8 프로덕션 보안 배포
./scripts/deploy-phase8.sh prod liveinsight-demo.com
```

## 📝 배포 후 설정

### 1. 서비스 URL 확인
```bash
# 전체 출력 확인
cd infrastructure
terraform output

# 주요 URL
echo "=== LiveInsight 서비스 URL ==="
echo "웹 애플리케이션: http://LiveInsight-alb-552300943.us-east-1.elb.amazonaws.com"
echo "API Gateway: https://qnwoi1ardd.execute-api.us-east-1.amazonaws.com/prod"
```

### 2. 모니터링 대시보드
```bash
# CloudWatch 대시보드 URL
echo "=== 모니터링 대시보드 ==="
echo "ECS 대시보드: https://console.aws.amazon.com/cloudwatch/home?region=us-east-1#dashboards:name=LiveInsight-dashboard"
echo "비즈니스 대시보드: https://console.aws.amazon.com/cloudwatch/home?region=us-east-1#dashboards:name=LiveInsight-BusinessMetrics"
echo "X-Ray 서비스 맵: https://console.aws.amazon.com/xray/home?region=us-east-1#/service-map"
```

### 3. 리소스 정보
```bash
# DynamoDB 테이블
echo "=== DynamoDB 테이블 ==="
echo "Events Table: LiveInsight-Events"
echo "Sessions Table: LiveInsight-Sessions"
echo "ActiveSessions Table: LiveInsight-ActiveSessions"

# ECS 서비스
echo "=== ECS 서비스 ==="
echo "Cluster: LiveInsight-cluster"
echo "Service: LiveInsight-service"
echo "ECR Repository: liveinsight-app"
```

## 🧪 배포 검증

### Phase 7 통합 테스트 실행
```bash
# 테스트 스크립트 실행 권한 부여
chmod +x scripts/*.sh

# 전체 통합 테스트
./scripts/run-tests.sh all

# E2E 테스트
./scripts/run-tests.sh e2e

# 성능 테스트
./scripts/run-tests.sh performance

# 로컬 Django 테스트
./scripts/test.sh local

# 배포된 애플리케이션 테스트
./scripts/test.sh deployment
```

### 수동 검증
```bash
# 1. DynamoDB 테이블 상태 확인
aws dynamodb list-tables --query 'TableNames[?contains(@, `LiveInsight`)]' --output table

# 2. Lambda 함수 상태 확인
aws lambda get-function --function-name LiveInsight-EventCollector --query 'Configuration.{Name:FunctionName,Runtime:Runtime,State:State}' --output table

# 3. ECS 서비스 상태 확인
aws ecs describe-services --cluster LiveInsight-cluster --services LiveInsight-service --query 'services[0].{Name:serviceName,Status:status,Running:runningCount,Desired:desiredCount}' --output table

# 4. ALB 헬스체크 확인
ALB_DNS="LiveInsight-alb-552300943.us-east-1.elb.amazonaws.com"
curl -f "http://$ALB_DNS/health/" || echo "Service may still be starting"

# 5. API Gateway 테스트
curl "https://qnwoi1ardd.execute-api.us-east-1.amazonaws.com/prod/events" -X POST -H "Content-Type: application/json" -d '{"test": "data"}'

# 6. CloudWatch 메트릭 확인
aws cloudwatch list-metrics --namespace "LiveInsight/Lambda" --output table
aws cloudwatch list-metrics --namespace "AWS/ECS" --dimensions Name=ServiceName,Value=LiveInsight-service --output table
```eInsight
aws cloudwatch list-metrics --namespace AWS/ECS
aws cloudwatch list-metrics --namespace AWS/ApplicationELB

# 8. X-Ray 트레이스 확인
aws xray get-service-graph --start-time $(date -d '1 hour ago' +%s) --end-time $(date +%s)
```

## 🔄 업데이트 및 재배포

### Django 애플리케이션 업데이트
```bash
# 일반 배포
./scripts/deploy.sh

# 블루-그린 배포 (무중단)
./scripts/blue-green-deploy.sh

# 특정 이미지 태그로 배포
./scripts/blue-green-deploy.sh v1.2.0
```

### Lambda 함수 코드 업데이트
```bash
# Lambda 함수 코드만 업데이트
cd infrastructure
zip -f lambda_function.zip lambda_function.py
aws lambda update-function-code \
  --function-name LiveInsight-EventCollector \
  --zip-file fileb://lambda_function.zip
```

### 인프라 업데이트
```bash
# Terraform으로 인프라 업데이트
terraform plan
terraform apply
```

### 롤백
```bash
# ECS 서비스 롤백 (자동)
./scripts/rollback.sh

# Lambda 함수 롤백
cd infrastructure
chmod +x rollback.sh
./rollback.sh

# Terraform으로 특정 리소스 롤백
terraform apply -target=aws_lambda_function.event_collector
terraform apply -target=aws_ecs_service.app
```

## 🗑️ 리소스 삭제

### 전체 삭제
```bash
# Terraform으로 모든 리소스 삭제
terraform destroy -auto-approve

# 확인
aws dynamodb list-tables --query 'TableNames[?contains(@, `LiveInsight`)]'
```

### 선택적 삭제
```bash
# 특정 리소스만 삭제
terraform destroy -target=aws_dynamodb_table.events
terraform destroy -target=aws_lambda_function.event_collector
```

## 💰 비용 최적화

### 예상 비용 (월간) - Phase 1-9 전체
```
Phase 1-5: DynamoDB 인프라
├── DynamoDB (프로비저닝 모드): ~$12
├── Lambda (100만 요청): ~$2.20
└── API Gateway (100만 요청): ~$3.50
소계: ~$28.50/월

Phase 6: 웹 애플리케이션 인프라
├── ECS Fargate (1 태스크): ~$15
├── ALB: ~$20
├── NAT Gateway (2개): ~$32
├── ECR 스토리지: ~$2
└── 기본 CloudWatch: ~$5
소계: ~$42.00/월

Phase 7: 고급 모니터링
├── 고급 CloudWatch 메트릭: ~$10
├── X-Ray 트레이싱: ~$5
└── 추가 로그 스토리지: ~$3
소계: ~$18.33/월

Phase 8: 프로덕션 보안 및 도메인
├── Route 53 (DNS + 헬스체크): ~$1.40
├── CloudFront CDN (1TB): ~$9.75
├── WAF 보안: ~$2.10
├── S3 정적 자산: ~$1.53
├── GuardDuty 위협 탐지: ~$3.00
└── KMS + Parameter Store: ~$1.05
소계: ~$25.50/월

Phase 9: 백업 및 재해복구
├── DynamoDB PITR: ~$8.50
├── 백업 스토리지 (S3): ~$4.20
├── Lambda 실행 비용: ~$2.80
├── 고급 모니터링: ~$6.30
├── CloudWatch 대시보드: ~$3.00
└── EventBridge 스케줄: ~$1.20
소계: ~$26.00/월

총 예상 비용: ~$140.33/월 (전체 시스템 Phase 1-9)
```

### 비용 절약 방법
```bash
# DynamoDB On-Demand 모드로 변경
terraform apply -var="billing_mode=PAY_PER_REQUEST"

# ECS 태스크 수 조정 (개발 환경)
terraform apply -var="ecs_desired_count=1"

# NAT Gateway 1개로 축소 (개발 환경)
terraform apply -var="nat_gateway_count=1"

# CloudWatch 로그 보존 기간 단축
terraform apply -var="log_retention_days=7"

# X-Ray 샘플링 비율 조정
terraform apply -var="xray_sampling_rate=0.05"
```

## 🚨 트러블슈팅

### 일반적인 문제

#### 1. Terraform 초기화 실패
```bash
# 해결방법
rm -rf .terraform
terraform init
```

#### 2. IAM 권한 부족
```bash
# 필요한 권한 확인
aws iam simulate-principal-policy \
  --policy-source-arn $(aws sts get-caller-identity --query Arn --output text) \
  --action-names dynamodb:CreateTable lambda:CreateFunction
```

#### 3. Lambda 배포 실패
```bash
# 로그 확인
aws logs describe-log-groups --log-group-name-prefix /aws/lambda/LiveInsight

# 함수 상태 확인
aws lambda get-function --function-name LiveInsight-EventCollector
```

#### 4. ECS 서비스 시작 실패
```bash
# ECS 서비스 상태 확인
aws ecs describe-services --cluster liveinsight-cluster --services liveinsight-service

# 태스크 로그 확인
aws logs filter-log-events \
  --log-group-name /ecs/liveinsight \
  --start-time $(date -d '1 hour ago' +%s)000
```

#### 5. ALB 헬스체크 실패
```bash
# 타겟 그룹 상태 확인
aws elbv2 describe-target-health --target-group-arn $(cd infrastructure/web-app && terraform output -raw target_group_arn)

# Django 헬스체크 엔드포인트 테스트
curl -v "http://$(cd infrastructure/web-app && terraform output -raw alb_dns_name)/health/"
```

#### 6. 캐시 성능 문제
```bash
# Django 캐시 상태 확인
cd src
python manage.py shell -c "from django.core.cache import cache; print(cache.get('active_sessions'))"

# 캐시 통계 확인
curl "http://$(cd ../infrastructure/web-app && terraform output -raw alb_dns_name)/api/sessions/active/" -w "Time: %{time_total}s\n"
```

#### 7. API Gateway 5xx 에러
```bash
# Lambda 로그 확인
aws logs filter-log-events \
  --log-group-name /aws/lambda/LiveInsight-EventCollector \
  --start-time $(date -d '1 hour ago' +%s)000

# X-Ray 트레이스 확인
aws xray get-trace-summaries \
  --time-range-type TimeRangeByStartTime \
  --start-time $(date -d '1 hour ago' +%s) \
  --end-time $(date +%s)
```

## 📞 지원 및 문의

### 문서 참조
- [AWS Lambda 개발자 가이드](https://docs.aws.amazon.com/lambda/)
- [Amazon DynamoDB 개발자 가이드](https://docs.aws.amazon.com/dynamodb/)
- [Amazon API Gateway 개발자 가이드](https://docs.aws.amazon.com/apigateway/)

### 로그 및 모니터링
- **CloudWatch 로그**: `/aws/lambda/LiveInsight-EventCollector`
- **CloudWatch 메트릭**: `LiveInsight` 네임스페이스
- **X-Ray 트레이싱**: Lambda 함수에서 활성화됨

이 배포 가이드를 따라하면 LiveInsight 인프라를 성공적으로 배포하고 운영할 수 있습니다.