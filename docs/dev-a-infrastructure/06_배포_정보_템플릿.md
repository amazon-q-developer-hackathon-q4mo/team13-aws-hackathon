# LiveInsight 배포 정보 템플릿

> 이 파일은 실제 배포 후 담당자 B에게 제공할 정보의 템플릿입니다.  
> 실제 배포 정보는 `DEPLOYMENT_INFO.md` 파일로 별도 생성됩니다.

## 🚀 배포 상태 템플릿
- **Phase 1**: ✅ 완료 (기초 인프라)
- **Phase 2**: ✅ 완료 (핵심 인프라)
- **배포 일시**: `<DEPLOYMENT_DATE>`
- **배포 리전**: `<AWS_REGION>`
- **환경**: `<ENVIRONMENT>`

## 🌐 API 엔드포인트 구조

### Base URL 형식
```
https://<API_GATEWAY_ID>.execute-api.<AWS_REGION>.amazonaws.com/<ENVIRONMENT>
```

### 엔드포인트 구성
| 메서드 | 경로 | Lambda 함수 패턴 | 용도 |
|--------|------|------------------|------|
| POST | `/api/events` | `liveinsight-event-collector-<ENV>` | 이벤트 수집 |
| GET | `/api/realtime` | `liveinsight-realtime-api-<ENV>` | 실시간 데이터 조회 |
| GET | `/api/stats` | `liveinsight-stats-api-<ENV>` | 통계 데이터 조회 |

### API 테스트 템플릿
```bash
# Stats API 테스트
curl -X GET "https://<API_GATEWAY_ID>.execute-api.<AWS_REGION>.amazonaws.com/<ENV>/api/stats"

# Events API 테스트
curl -X POST "https://<API_GATEWAY_ID>.execute-api.<AWS_REGION>.amazonaws.com/<ENV>/api/events" \
  -H "Content-Type: application/json" \
  -d '{"event_type": "page_view", "timestamp": 1693900000}'
```

## 🗄️ 데이터베이스 스키마

### DynamoDB 테이블 구조
| 테이블명 패턴 | 용도 | Hash Key | Range Key |
|---------------|------|----------|-----------|
| `liveinsight-events-<ENV>` | 이벤트 저장 | session_id | timestamp |
| `liveinsight-sessions-<ENV>` | 세션 관리 | session_id | - |

### Events 테이블 스키마
```json
{
  "session_id": "string",
  "timestamp": "number",
  "event_type": "string",
  "page_url": "string",
  "user_agent": "string",
  "referrer": "string",
  "ttl": "number"
}
```

### Sessions 테이블 스키마
```json
{
  "session_id": "string",
  "is_active": "string",
  "last_activity": "number",
  "start_time": "number",
  "user_agent": "string",
  "initial_referrer": "string"
}
```

## 🔧 Lambda 함수 구성

### 환경 변수 패턴
모든 Lambda 함수에 다음 환경 변수가 설정됩니다:
```
EVENTS_TABLE=liveinsight-events-<ENV>
SESSIONS_TABLE=liveinsight-sessions-<ENV>
AWS_REGION=<AWS_REGION>
```

### 함수 설정
- **Runtime**: Python 3.11
- **Memory**: 256MB
- **Timeout**: 30초
- **IAM Role**: `liveinsight-lambda-role-<ENV>`

### 권한
Lambda 함수는 다음 DynamoDB 작업 권한을 가집니다:
- GetItem, PutItem, Query, Scan
- UpdateItem, DeleteItem
- BatchWriteItem, BatchGetItem

## 🌍 대시보드 접근

### URL 구조
- **CloudFront**: `https://<CLOUDFRONT_DOMAIN>`
- **S3 Direct**: `http://<S3_BUCKET>.s3-website-<AWS_REGION>.amazonaws.com`

### 정적 파일 업로드 방법
```bash
# S3 버킷에 파일 업로드
aws s3 cp your-file.html s3://<S3_BUCKET>/

# CloudFront 캐시 무효화 (필요시)
aws cloudfront create-invalidation --distribution-id <DISTRIBUTION_ID> --paths "/*"
```

## 📊 모니터링 구성

### CloudWatch 로그 그룹 패턴
- `/aws/lambda/liveinsight-event-collector-<ENV>`
- `/aws/lambda/liveinsight-realtime-api-<ENV>`
- `/aws/lambda/liveinsight-stats-api-<ENV>`
- `API-Gateway-Execution-Logs_<API_GATEWAY_ID>/<ENV>`

### 로그 확인 명령어 템플릿
```bash
# Lambda 로그 실시간 확인
aws logs tail /aws/lambda/liveinsight-event-collector-<ENV> --follow

# 에러 로그만 필터링
aws logs filter-log-events \
  --log-group-name /aws/lambda/liveinsight-event-collector-<ENV> \
  --filter-pattern "ERROR"
```

## 🔄 코드 배포 가이드

### Lambda 함수 코드 업데이트
```bash
# 1. 코드 압축 (requirements.txt 포함)
zip -r function.zip src/ requirements.txt

# 2. 함수 업데이트
aws lambda update-function-code \
  --function-name liveinsight-event-collector-<ENV> \
  --zip-file fileb://function.zip

# 3. 배포 확인
aws lambda get-function --function-name liveinsight-event-collector-<ENV>
```

### 환경 변수 관리
```bash
# 현재 환경 변수 확인
aws lambda get-function-configuration \
  --function-name liveinsight-event-collector-<ENV>

# 환경 변수 업데이트 (필요시)
aws lambda update-function-configuration \
  --function-name liveinsight-event-collector-<ENV> \
  --environment Variables='{EVENTS_TABLE=liveinsight-events-<ENV>,SESSIONS_TABLE=liveinsight-sessions-<ENV>}'
```

## 🚨 주의사항

### CORS 설정
- 모든 API 엔드포인트에 CORS가 설정되어 있습니다
- Origin: `*` (모든 도메인 허용)
- Methods: `GET, POST, OPTIONS`
- Headers: `Content-Type, X-API-Key, Authorization`

### 현재 알려진 이슈
- OPTIONS 메서드가 500 에러 반환 (기능상 문제없음)
- 실제 Lambda 코드 구현 필요 (현재 더미 응답)

### 보안 고려사항
- API에 인증이 설정되어 있지 않음 (개발 환경)
- DynamoDB 테이블에 TTL 설정됨 (자동 데이터 삭제)

## 🤝 협업 가이드

### 코드 구조 권장사항
```
src/
├── handlers/
│   ├── event_collector.py
│   ├── realtime_api.py
│   └── stats_api.py
├── models/
│   ├── events.py
│   └── sessions.py
└── utils/
    ├── dynamodb.py
    └── response.py
```

### 응답 형식 통일
```python
# 성공 응답
{
    "statusCode": 200,
    "headers": {
        "Content-Type": "application/json",
        "Access-Control-Allow-Origin": "*"
    },
    "body": json.dumps({
        "status": "success",
        "data": {...}
    })
}

# 에러 응답
{
    "statusCode": 400,
    "headers": {
        "Content-Type": "application/json",
        "Access-Control-Allow-Origin": "*"
    },
    "body": json.dumps({
        "status": "error",
        "message": "Error description"
    })
}
```

## 📞 문의사항
인프라 관련 문의사항이 있으면 담당자 A에게 연락하세요.

---
**마지막 업데이트**: `<UPDATE_DATE>`
**문서 버전**: 2.0

## 📝 템플릿 사용 방법

### 실제 배포 정보 생성
1. **배포 완료 후**: `terraform output` 명령으로 실제 값 확인
2. **파일 생성**: 이 템플릿을 복사하여 `DEPLOYMENT_INFO.md` 생성
3. **값 교체**: 모든 `<PLACEHOLDER>` 를 실제 배포된 값으로 교체
4. **보안**: `DEPLOYMENT_INFO.md`는 `.gitignore`에 포함 (GitHub 업로드 방지)

### Terraform 출력값 확인
```bash
cd terraform
terraform output  # 모든 출력값 확인
terraform output api_gateway_url  # 특정 값만 확인
```

### 플레이스홀더 목록
- `<API_GATEWAY_ID>`: API Gateway ID
- `<AWS_REGION>`: AWS 리전 (예: us-east-1)
- `<ENVIRONMENT>`: 환경 (dev/prod)
- `<CLOUDFRONT_DOMAIN>`: CloudFront 도메인
- `<S3_BUCKET>`: S3 버킷명
- `<DEPLOYMENT_DATE>`: 배포 일시