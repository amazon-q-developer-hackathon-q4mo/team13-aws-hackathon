# LiveInsight 아키텍처 설계

## 구현 우선순위

### Phase 1 (MVP - 해커톤 기간)
**목표**: 기본 기능 구현으로 동작하는 프로토타입 완성
- [x] 기본 추적 스크립트 (liveinsight.js)
- [x] 이벤트 수집 API (POST /api/events)
- [x] 간단한 대시보드 (현재 접속자, 페이지뷰)
- [x] DynamoDB 기본 테이블 구조
- [x] Lambda 함수 3개 (Event Collector, Realtime API, Stats API)

**예상 소요시간**: 2-3일
**핵심 기능**: 실시간 접속자 수, 기본 페이지뷰 통계

### Phase 2 (개선 - 해커톤 후)
**목표**: 실용적인 분석 도구로 발전
- [ ] 통계 집계 시스템 (EventBridge + 집계 Lambda)
- [ ] 차트 및 상세 분석 (Chart.js 활용)
- [ ] 성능 최적화 (배치 처리, 캐싱)
- [ ] 대시보드 인증 (Cognito)
- [ ] API Key 관리 시스템

**예상 소요시간**: 1-2주
**핵심 기능**: 시간별/일별 통계, 페이지별 분석, 사용자 세션 추적

### Phase 3 (확장 - 장기)
**목표**: 엔터프라이즈급 분석 플랫폼
- [ ] WebSocket 실시간 업데이트
- [ ] 고급 분석 기능 (퍼널, 코호트)
- [ ] 다중 사이트 지원
- [ ] 알림 및 리포트 시스템
- [ ] 모바일 대시보드

**예상 소요시간**: 1-2개월
**핵심 기능**: 실시간 알림, 고급 분석, 다중 테넌트

## 전체 시스템 아키텍처

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   사용자 웹사이트   │    │   추적 스크립트      │    │   관리자 대시보드   │
│                 │    │                 │    │                 │
│ example.com     │    │ liveinsight.js  │    │ dashboard.html  │
│                 │    │                 │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                        │                        │
         │                        │                        │
         ▼                        ▼                        ▼
┌─────────────────────────────────────────────────────────────────┐
│                        AWS Cloud                               │
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐                    │
│  │  API Gateway    │    │  S3 + CloudFront│                    │
│  │                 │    │                 │                    │
│  │ POST /events    │    │ Static Hosting  │                    │
│  │ GET /realtime   │    │ Dashboard UI    │                    │
│  │ GET /stats      │    │                 │                    │
│  └─────────────────┘    └─────────────────┘                    │
│           │                                                    │
│           ▼                                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                Lambda Functions                         │   │
│  │                                                         │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │   │
│  │  │Event        │  │Realtime     │  │Stats        │     │   │
│  │  │Collector    │  │API          │  │API          │     │   │
│  │  │             │  │             │  │             │     │   │
│  │  │- 이벤트 수집  │  │- 현재 접속자 │  │- 일간 통계   │     │   │
│  │  │- 데이터 검증  │  │- 실시간 현황 │  │- 페이지 통계  │     │   │
│  │  │- 세션 관리   │  │- HTML 응답  │  │- 차트 데이터  │     │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘     │   │
│  └─────────────────────────────────────────────────────────┘   │
│           │                                                    │
│           ▼                                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    DynamoDB                             │   │
│  │                                                         │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │   │
│  │  │Events       │  │Sessions     │  │Stats        │     │   │
│  │  │             │  │             │  │             │     │   │
│  │  │PK: session  │  │PK: session  │  │PK: date     │     │   │
│  │  │SK: timestamp│  │- user_id    │  │SK: metric   │     │   │
│  │  │- event_type │  │- start_time │  │- value      │     │   │
│  │  │- page_url   │  │- is_active  │  │             │     │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘     │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 핵심 컴포넌트 설계

### 1. 추적 스크립트 (JavaScript SDK)

**목적**: 사용자 웹사이트에서 이벤트 수집
**특징**: 경량화, 비동기 처리, 배치 전송

```javascript
// 사용법: 웹사이트에 한 줄 추가
<script src="https://cdn.liveinsight.io/tracker.js" data-api-key="YOUR_API_KEY"></script>
```

**주요 기능**:
- 페이지뷰 자동 추적
- 세션 관리 (클라이언트 사이드)
- 배치 처리로 성능 최적화
- 오프라인 지원 (로컬 스토리지)

### 2. API Gateway 엔드포인트

**이벤트 수집 API**:
- `POST /api/events` - 이벤트 배치 수집
- Rate Limiting: 1000 req/min
- CORS 활성화

**대시보드 API**:
- `GET /api/realtime/users` - 현재 접속자 수
- `GET /api/realtime/pages` - 실시간 페이지 현황
- `GET /api/stats/daily` - 일간 통계
- `GET /api/stats/pages` - 페이지별 통계

### 3. Lambda Functions

#### Event Collector
```python
# 역할: 이벤트 수집 및 저장
# 입력: 이벤트 배치 (JSON)
# 출력: 성공/실패 응답
# 처리: DynamoDB 배치 쓰기, 세션 업데이트
```

#### Realtime API
```python
# 역할: 실시간 현황 제공
# 입력: 없음
# 출력: HTML 또는 JSON
# 처리: 활성 세션 조회, 실시간 집계
```

#### Stats API
```python
# 역할: 통계 데이터 제공
# 입력: 날짜 범위, 필터
# 출력: HTML 또는 JSON
# 처리: 집계 데이터 조회, 차트 데이터 생성
```

### 4. DynamoDB 테이블 설계

#### Events 테이블 (MVP 단순 설계)
```
PK: session_id (String)
SK: timestamp (Number)
Attributes:
- event_type: "page_view" | "session_start" | "session_end"
- page_url: String
- user_agent: String
- referrer: String
- ttl: Number (24시간 후 자동 삭제)

GSI: EventTypeIndex
- PK: event_type
- SK: timestamp

# Phase 2에서 멀티사이트 지원 시 site_id 추가 예정
```

#### Sessions 테이블 (MVP 단순 설계)
```
PK: session_id (String)
Attributes:
- user_id: String
- start_time: Number
- last_activity: Number
- is_active: Boolean
- page_count: Number
- referrer: String
- user_agent: String

GSI: ActivityIndex
- PK: is_active
- SK: last_activity

# Phase 2에서 멀티사이트 지원 시 site_id 추가 예정
```

#### Stats 테이블 (집계 데이터)
```
PK: date (String) "2024-01-15"
SK: metric_type (String) "daily_visitors" | "page_views" | "hourly_stats"
Attributes:
- value: Number
- dimensions: Map (페이지별, 시간별 세부 데이터)
- created_at: Number

# Phase 2에서 멀티사이트 지원 시 site_id 추가 예정
```

### 5. 대시보드 UI

**기술 스택**:
- HTML + Vanilla JavaScript
- Chart.js (차트 라이브러리)
- Tailwind CSS (스타일링)
- 폴링 기반 실시간 업데이트

**주요 위젯**:
- 현재 접속자 수 (3초 간격 업데이트)
- 실시간 페이지 현황 (5초 간격)
- 일간 방문자 차트 (30초 간격)
- 페이지별 조회수 테이블 (30초 간격)

## 데이터 플로우

### 이벤트 수집 플로우
```
1. 사용자가 웹페이지 방문
2. 추적 스크립트가 이벤트 생성
3. 배치로 API Gateway에 전송
4. Event Collector Lambda가 처리
5. DynamoDB Events 테이블에 저장
6. Sessions 테이블 업데이트
```

### 실시간 모니터링 플로우
```
1. 대시보드에서 폴링 요청
2. API Gateway → Realtime API Lambda
3. DynamoDB에서 활성 세션 조회
4. 집계 계산 후 HTML 응답
5. 대시보드 UI 업데이트
```

### 통계 생성 플로우 (개선된 방식)
```
방식 1: 스케줄 기반 (Phase 1)
1. EventBridge 스케줄러 (매시간)
2. Stats Lambda 함수 실행
3. Events 테이블에서 데이터 집계
4. Stats 테이블에 결과 저장

방식 2: 실시간 집계 (Phase 2)
1. DynamoDB Streams 활성화
2. Events 테이블 변경 시 트리거
3. Stream Lambda가 실시간 집계 업데이트
4. Stats 테이블 즉시 반영
```

## 성능 최적화 전략

### 1. 데이터베이스 최적화
- **배치 쓰기**: 이벤트를 배치로 처리하여 DynamoDB 비용 절약
- **TTL 설정**: 24시간 후 자동 삭제로 스토리지 비용 최적화
- **GSI 활용**: 쿼리 패턴에 맞는 인덱스 설계

### 2. API 최적화
- **캐싱**: 실시간 데이터 3초, 통계 데이터 30초 캐시
- **압축**: Gzip 압축으로 응답 크기 최소화
- **배치 처리**: 여러 이벤트를 한 번에 처리

### 3. 프론트엔드 최적화
- **폴링 간격**: 중요도에 따라 차등 적용
- **레이지 로딩**: 차트 데이터 필요시에만 로드
- **CDN 활용**: CloudFront로 전역 배포

## 보안 설계 (강화된 보안)

### 1. 인증 및 권한
- **API Key**: 추적 스크립트용 공개 키
- **API Key 로테이션**: 정기적 키 갱신 메커니즘
- **대시보드 인증**: Amazon Cognito 사용자 풀
- **CORS**: 허용된 도메인만 API 접근
- **Rate Limiting**: DDoS 공격 방지 (1000 req/min)

### 2. 데이터 보호
- **IP 마스킹**: 개인정보 보호 (마지막 옥텟 마스킹)
- **HTTPS 강제**: 모든 통신 암호화
- **데이터 최소화**: 필요한 데이터만 수집
- **암호화**: DynamoDB 저장 시 암호화

### 3. 모니터링 및 감사
- **CloudWatch**: 비정상 트래픽 감지
- **CloudTrail**: API 호출 감사 로그
- **알람**: 임계치 초과 시 알림
- **사용자별 API 사용량**: 남용 방지
- **오류율 모니터링**: 시스템 건강성 추적

## 확장성 고려사항

### 1. 트래픽 증가 대응
- **Lambda 동시 실행**: 자동 스케일링
- **DynamoDB**: On-Demand 모드로 자동 확장
- **API Gateway**: 자동 부하 분산

### 2. 기능 확장
- **마이크로서비스**: Lambda 함수별 독립 배포
- **이벤트 기반**: EventBridge로 느슨한 결합
- **모듈화**: 새 기능 추가 시 기존 코드 영향 최소화

### 3. 다중 리전 지원
- **데이터 복제**: 주요 리전에 백업
- **지연시간 최적화**: 사용자 근접 리전에서 서비스
- **장애 복구**: 자동 페일오버 구성

## 비용 최적화

### 1. 서버리스 활용
- **Lambda**: 사용한 만큼만 과금
- **DynamoDB**: On-Demand 모드 (예측 불가능한 트래픽)
- **API Gateway**: 호출당 과금
- **CloudFront**: 글로벌 CDN으로 대역폭 비용 절약

### 2. 데이터 관리
- **TTL**: 불필요한 데이터 자동 삭제 (24시간)
- **압축**: Gzip 압축으로 스토리지/전송 비용 절약
- **집계**: 원시 데이터 대신 집계 데이터 활용
- **배치 처리**: DynamoDB 배치 쓰기로 비용 절약

### 3. 모니터링 및 최적화
- **비용 알람**: 예산 초과 시 알림
- **사용량 추적**: 리소스별 비용 모니터링
- **Lambda 메모리 최적화**: 적절한 메모리 할당 (256MB 권장)
- **정기적 검토**: 월별 비용 분석 및 최적화

### 4. 예상 비용 (월 100만 이벤트 기준)
- **Lambda**: ~$2-3
- **DynamoDB**: ~$5-10 (On-Demand)
- **API Gateway**: ~$3-4
- **CloudFront**: ~$1-2
- **총 예상 비용**: ~$11-19/월

## 성능 목표 및 SLA

### 응답 시간 목표
- **이벤트 수집 API**: <100ms (P95)
- **실시간 API**: <200ms (P95)
- **통계 API**: <500ms (P95)
- **대시보드 로딩**: <2초 (초기 로딩)

### 가용성 목표
- **API 가용성**: 99.9%
- **데이터 내구성**: 99.999999999% (DynamoDB)
- **실시간 업데이트 지연**: <5초

### 확장성 목표
- **동시 사용자**: 10,000명
- **초당 이벤트**: 1,000개
- **월간 이벤트**: 100만개 (초기), 1억개 (확장)

## 실시간 처리 개선 방안

### Phase 1: 폴링 기반
```javascript
// 현재 구현 방식
setInterval(() => {
  fetchRealtimeData();
}, 3000); // 3초 간격
```

### Phase 2: WebSocket 추가 (선택적)
```javascript
// WebSocket 기반 실시간 업데이트
const ws = new WebSocket('wss://api.liveinsight.io/realtime');
ws.onmessage = (event) => {
  updateDashboard(JSON.parse(event.data));
};
```

**WebSocket 도입 시 고려사항**:
- API Gateway WebSocket 사용
- 연결 관리 Lambda 함수 필요
- 비용 증가 (연결당 과금)
- 복잡도 증가

**권장사항**: Phase 1에서는 폴링 방식으로 시작, 사용자 피드백에 따라 Phase 2에서 WebSocket 도입 검토