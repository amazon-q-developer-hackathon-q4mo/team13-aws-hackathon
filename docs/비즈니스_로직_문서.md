# LiveInsight 비즈니스 로직 상세 문서

## 📊 시스템 개요

LiveInsight는 실시간 웹 분석 플랫폼으로, 웹사이트 방문자의 행동을 실시간으로 추적하고 분석하여 비즈니스 인사이트를 제공합니다.

## 🏗️ 데이터 아키텍처

### 데이터 흐름도
```
웹사이트 방문자
    ↓ (JavaScript SDK)
API Gateway + Lambda
    ↓ (이벤트 처리)
DynamoDB (3개 테이블)
    ↓ (실시간 조회)
Django REST API
    ↓ (시각화)
실시간 대시보드
```

### 핵심 데이터 모델

#### 1. Events 테이블 (이벤트 저장소)
```json
{
  "event_id": "evt_20241201_123456_abc123",     // Primary Key
  "timestamp": 1701432000000,                   // Sort Key (밀리초)
  "user_id": "user_abc123",                     // 영구 사용자 식별자
  "session_id": "sess_20241201_abc123",         // 세션 식별자
  "event_type": "page_view",                    // 이벤트 타입
  "page_url": "/products/item1",                // 페이지 URL
  "referrer": "https://google.com",             // 유입 경로
  "user_agent": "Mozilla/5.0...",               // 브라우저 정보
  "ip_address": "192.168.1.1"                  // 클라이언트 IP
}
```

**이벤트 타입:**
- `page_view`: 페이지 조회
- `click`: 버튼/링크 클릭
- `conversion`: 전환 이벤트
- `heartbeat`: 활성 상태 유지 (30초마다)

#### 2. Sessions 테이블 (세션 메타데이터)
```json
{
  "session_id": "sess_20241201_abc123",         // Primary Key
  "user_id": "user_abc123",                     // 사용자 식별자
  "start_time": 1701432000000,                  // 세션 시작 시간
  "last_activity": 1701433800000,               // 마지막 활동 시간
  "is_active": true,                            // 활성 상태
  "entry_page": "/home",                        // 진입 페이지
  "exit_page": "/products/item1",               // 이탈 페이지
  "referrer": "https://google.com",             // 유입 경로
  "total_events": 15,                           // 총 이벤트 수
  "session_duration": 1800                      // 세션 지속 시간(초)
}
```

#### 3. ActiveSessions 테이블 (실시간 활성 세션)
```json
{
  "session_id": "sess_20241201_abc123",         // Primary Key
  "user_id": "user_abc123",                     // 사용자 식별자
  "last_activity": 1701433800000,               // 마지막 활동
  "current_page": "/products/item1",            // 현재 페이지
  "expires_at": 1701435600                      // TTL (30분 후 자동 삭제)
}
```

## 🔄 비즈니스 로직 상세

### 1. 데이터 수집 프로세스

#### JavaScript SDK 동작 흐름
```javascript
// 1. 사용자 식별자 생성/조회
getUserId() {
    let userId = localStorage.getItem('li_user_id');
    if (!userId) {
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('li_user_id', userId);  // 영구 저장
    }
    return userId;
}

// 2. 세션 식별자 생성/조회
getSessionId() {
    let sessionId = sessionStorage.getItem('li_session_id');
    if (!sessionId) {
        sessionId = 'sess_' + Date.now() + '_' + this.userId.substr(-8);
        sessionStorage.setItem('li_session_id', sessionId);  // 브라우저 세션 동안만
    }
    return sessionId;
}
```

#### 이벤트 수집 시나리오
1. **페이지 로드**: 자동으로 `page_view` 이벤트 발생
2. **사용자 상호작용**: 버튼/링크 클릭 시 `click` 이벤트 발생
3. **전환 추적**: 개발자가 수동으로 `conversion` 이벤트 호출
4. **활성 상태 유지**: 30초마다 `heartbeat` 이벤트 자동 발생

### 2. 서버리스 데이터 처리

#### Lambda 함수 처리 로직
```python
def lambda_handler(event, context):
    # 1. 이벤트 데이터 생성
    event_data = create_event_data(body, event)
    
    # 2. 세션 관리 (신규 생성 또는 기존 업데이트)
    session_data = manage_session(event_data)
    
    # 3. 데이터 저장 (3개 테이블)
    save_event_data(event_data, session_data)
    
    # 4. CloudWatch 메트릭 전송
    put_custom_metric('EventsProcessed', 1)
```

#### 세션 생명주기 관리
```
새 방문자 → 새 세션 생성 → 이벤트 발생 → 세션 업데이트 → 30분 비활성 → 세션 만료
```

### 3. 실시간 분석 API

#### 주요 API 엔드포인트
```python
# 활성 세션 조회 (30초 캐시)
GET /api/sessions/active/
→ ActiveSessions 테이블 스캔

# 시간대별 통계 (5분 단위, 최근 100분)
GET /api/statistics/hourly/
→ Events 테이블 시간 범위 쿼리

# 페이지별 통계
GET /api/statistics/pages/
→ Events 테이블에서 page_view 이벤트 집계

# 유입경로별 통계
GET /api/statistics/referrers/
→ Events 테이블에서 referrer 분석
```

#### 데이터 집계 로직
```python
def aggregate_by_hour(self, events):
    # 최근 100분을 5분 단위로 나누어 20개 포인트 생성
    for i in range(20):
        time_point = now - timedelta(minutes=(19 - i) * 5)
        time_key = time_point.strftime('%H:%M')
        hourly_counts[time_key] = 0
    
    # 실제 이벤트로 카운트 업데이트
    for event in events:
        # 5분 단위로 반올림하여 집계
        minute_slot = (event_time.minute // 5) * 5
        event_rounded = event_time.replace(minute=minute_slot)
        hourly_counts[time_key] += 1
```

## 📈 대시보드 기능

### 실시간 지표
1. **현재 활성 사용자**: ActiveSessions 테이블 카운트
2. **총 이벤트 수**: Events 테이블 카운트 (최근 24시간)
3. **평균 세션 시간**: 활성 세션들의 평균 지속 시간
4. **전환율**: conversion 이벤트 / 총 이벤트 비율

### 시각화 차트
1. **시간대별 트래픽**: Line Chart (Chart.js)
2. **페이지별 조회수**: Bar Chart
3. **유입경로 분포**: Pie Chart
4. **실시간 활성 세션**: Table with Auto-refresh

## 🔍 데이터 접근 패턴

### DynamoDB 인덱스 설계
```
Primary Table: Events
├── Primary Key: event_id
├── Sort Key: timestamp
├── GSI-1: user_id + timestamp (사용자별 이벤트 조회)
└── GSI-2: session_id + timestamp (세션별 이벤트 조회)

Primary Table: Sessions  
├── Primary Key: session_id
└── GSI-1: user_id + start_time (사용자별 세션 히스토리)

Primary Table: ActiveSessions
├── Primary Key: session_id
└── TTL: expires_at (30분 자동 만료)
```

### 쿼리 최적화
1. **실시간 조회**: ActiveSessions 스캔 (소량 데이터)
2. **시간 범위 조회**: Events 테이블 timestamp 필터
3. **사용자별 조회**: GSI-1 활용
4. **세션별 조회**: GSI-2 활용

## 🚀 성능 최적화

### 캐싱 전략
```python
# 활성 세션 30초 캐시
@cache_page(30)
def active_sessions():
    return db_client.get_active_sessions()
```

### 배치 처리
- Lambda 동시 실행으로 높은 처리량 지원
- DynamoDB Auto Scaling으로 트래픽 급증 대응
- CloudWatch 메트릭으로 성능 모니터링

## 📊 비즈니스 인사이트

### 제공하는 분석 데이터
1. **실시간 모니터링**: 현재 접속자, 실시간 페이지뷰
2. **사용자 행동 분석**: 페이지별 체류시간, 클릭 패턴
3. **유입 경로 분석**: 트래픽 소스별 성과 측정
4. **전환 분석**: 목표 달성률, 퍼널 분석
5. **세션 분석**: 평균 세션 시간, 페이지뷰 수

### 활용 사례
- **E-commerce**: 상품 페이지 성과, 구매 전환율
- **미디어**: 콘텐츠 인기도, 사용자 참여도
- **SaaS**: 기능 사용률, 사용자 온보딩 효과
- **마케팅**: 캠페인 성과, 랜딩 페이지 최적화

이 구조를 통해 실시간으로 웹사이트 성과를 모니터링하고 데이터 기반 의사결정을 지원하는 완전한 웹 분석 플랫폼을 제공합니다.