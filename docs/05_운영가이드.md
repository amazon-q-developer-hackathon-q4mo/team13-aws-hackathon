# LiveInsight 운영 가이드

## 📊 시스템 개요

LiveInsight는 실시간 웹사이트 사용자 행동 분석 서비스로, AWS 서버리스 아키텍처를 기반으로 구축되었습니다.

### 주요 구성 요소
- **API Gateway**: 이벤트 수집 엔드포인트
- **Lambda**: 이벤트 처리 및 세션 관리
- **DynamoDB**: 이벤트 및 세션 데이터 저장
- **CloudWatch**: 모니터링 및 로깅

## 🔍 모니터링

### CloudWatch 대시보드
- **URL**: https://console.aws.amazon.com/cloudwatch/home?region=us-east-1#dashboards:
- **주요 메트릭**:
  - `AWS/Lambda/Duration`: Lambda 실행 시간
  - `AWS/Lambda/Errors`: Lambda 에러 발생 수
  - `AWS/Lambda/Invocations`: Lambda 호출 수
  - `LiveInsight/EventsProcessed`: 처리된 이벤트 수
  - `LiveInsight/ProcessingTime`: 이벤트 처리 시간

### 커스텀 메트릭
- **네임스페이스**: `LiveInsight`
- **차원**: `Environment=Production`
- **메트릭**:
  - `EventsProcessed`: 성공적으로 처리된 이벤트 수
  - `ProcessingTime`: 이벤트 처리 시간 (밀리초)
  - `ProcessingErrors`: 처리 중 발생한 에러 수

## 🚨 알람 설정

### 현재 활성화된 알람
1. **LiveInsight-Lambda-ErrorRate**
   - 조건: 5분간 에러 5회 이상
   - 평가 기간: 2회 연속

2. **LiveInsight-Lambda-Duration**
   - 조건: 평균 응답시간 5초 이상
   - 평가 기간: 2회 연속

3. **LiveInsight-DynamoDB-Throttles**
   - 조건: 스로틀링 발생 시 즉시
   - 평가 기간: 1회

### 알람 대응 절차
1. **Lambda 에러 알람**
   - CloudWatch 로그 확인: `/aws/lambda/LiveInsight-EventCollector`
   - 에러 패턴 분석 및 코드 수정
   - 필요시 메모리 증가 또는 타임아웃 조정

2. **응답시간 알람**
   - Lambda 메모리 사용량 확인
   - DynamoDB 응답시간 확인
   - 코드 최적화 검토

3. **DynamoDB 스로틀링**
   - 테이블 용량 증가 검토
   - 배치 처리 로직 적용
   - 읽기/쓰기 패턴 최적화

## 🔧 트러블슈팅

### 일반적인 문제와 해결방법

#### 1. Lambda 함수 타임아웃
**증상**: Lambda Duration 알람 발생, 504 Gateway Timeout
**해결방법**:
```bash
# 메모리 증가 (512MB → 1024MB)
aws lambda update-function-configuration \
  --function-name LiveInsight-EventCollector \
  --memory-size 1024

# 타임아웃 증가 (30초 → 60초)
aws lambda update-function-configuration \
  --function-name LiveInsight-EventCollector \
  --timeout 60
```

#### 2. DynamoDB 스로틀링
**증상**: ThrottledRequests 메트릭 증가, 500 Internal Server Error
**해결방법**:
```bash
# 읽기 용량 증가
aws dynamodb update-table \
  --table-name LiveInsight-Events \
  --provisioned-throughput ReadCapacityUnits=10,WriteCapacityUnits=10
```

#### 3. API Gateway 5xx 에러
**증상**: API 호출 시 5xx 응답
**해결방법**:
1. Lambda 함수 로그 확인
2. IAM 권한 확인
3. 환경 변수 설정 확인

### 로그 분석

#### CloudWatch 로그 쿼리 예시
```sql
-- 에러 로그 검색
fields @timestamp, @message
| filter @message like /ERROR/
| sort @timestamp desc
| limit 20

-- 응답시간 분석
fields @timestamp, @duration
| filter @type = "REPORT"
| stats avg(@duration), max(@duration), min(@duration) by bin(5m)
```

## 📈 성능 최적화

### 현재 성능 지표
- **평균 응답시간**: ~134ms
- **메모리 사용량**: ~84MB
- **콜드 스타트**: ~459ms (최초 1회)
- **처리량**: ~10 req/sec (테스트 기준)

### 최적화 권장사항
1. **Lambda 메모리 조정**: 사용량에 따라 512MB → 256MB 또는 1024MB
2. **DynamoDB 용량 모드**: 트래픽 패턴에 따라 On-Demand 모드 고려
3. **API Gateway 캐싱**: 정적 응답에 대한 캐싱 활성화

## 🔐 보안 관리

### IAM 역할 및 정책
- **역할**: `LiveInsight-Lambda-Role`
- **정책**:
  - `AWSLambdaBasicExecutionRole` (관리형)
  - `LiveInsight-DynamoDB-Policy` (사용자 정의)
  - `LiveInsight-CloudWatch-Policy` (사용자 정의)

### 보안 점검 항목
- [ ] IAM 역할 최소 권한 원칙 준수
- [ ] API Gateway CORS 설정 확인
- [ ] DynamoDB 테이블 암호화 활성화
- [ ] CloudWatch 로그 보존 기간 설정

## 🚀 배포 및 롤백

### 배포 절차
```bash
# 1. 배포 스크립트 실행
./deploy.sh

# 2. 수동 검증
curl -X POST https://qnwoi1ardd.execute-api.us-east-1.amazonaws.com/prod/events \
  -H "Content-Type: application/json" \
  -d '{"user_id":"test","event_type":"page_view","page_url":"https://example.com"}'
```

### 롤백 절차
```bash
# 1. 롤백 스크립트 실행
./rollback.sh

# 2. 상태 확인
aws lambda get-function --function-name LiveInsight-EventCollector
```

## 📞 비상 연락처

### 개발팀
- **개발자 A (인프라/백엔드)**: [연락처]
- **개발자 B (애플리케이션)**: [연락처]

### AWS 지원
- **지원 케이스**: AWS Console > Support Center
- **문서**: https://docs.aws.amazon.com/

### 에스컬레이션 절차
1. **Level 1**: 개발팀 내부 해결 시도
2. **Level 2**: AWS 기술 지원 요청
3. **Level 3**: 비즈니스 크리티컬 이슈 시 매니저 에스컬레이션

## 📋 정기 점검 항목

### 일일 점검
- [ ] CloudWatch 알람 상태 확인
- [ ] API 응답시간 확인
- [ ] 에러율 확인

### 주간 점검
- [ ] DynamoDB 용량 사용률 확인
- [ ] Lambda 함수 성능 분석
- [ ] 비용 사용량 검토

### 월간 점검
- [ ] 보안 설정 검토
- [ ] 백업 및 복구 절차 테스트
- [ ] 성능 최적화 검토