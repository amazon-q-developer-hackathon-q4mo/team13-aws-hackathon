{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>실시간 활성 세션</h2>
            <div>
                <span class="badge bg-success" id="active-count">0</span> 활성 사용자
                <button class="btn btn-sm btn-outline-primary ms-2" onclick="refreshSessions()">
                    <i class="fas fa-sync-alt"></i> 새로고침
                </button>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="sessions-table">
                        <thead>
                            <tr>
                                <th>사용자 ID</th>
                                <th>세션 ID</th>
                                <th>현재 페이지</th>
                                <th>활동 시간</th>
                                <th>지속 시간</th>
                                <th>액션</th>
                            </tr>
                        </thead>
                        <tbody id="sessions-tbody">
                            <!-- 동적으로 채워짐 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 세션 상세 모달 -->
<div class="modal fade" id="sessionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">세션 상세 정보</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="session-details">
                <!-- 세션 상세 정보 -->
            </div>
        </div>
    </div>
</div>

<script>
let sessionsData = [];
let refreshInterval;

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    loadActiveSessions();
    startAutoRefresh();
});

// 활성 세션 로드
async function loadActiveSessions() {
    try {
        const response = await fetch('/api/sessions/active/');
        const data = await response.json();
        sessionsData = data;
        renderSessionsTable(data);
        updateActiveCount(data.length);
    } catch (error) {
        console.error('Error loading sessions:', error);
        showError('세션 데이터를 불러오는데 실패했습니다.');
    }
}

// 세션 테이블 렌더링
function renderSessionsTable(sessions) {
    const tbody = document.getElementById('sessions-tbody');
    tbody.innerHTML = '';
    
    sessions.forEach(session => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${session.user_id}</td>
            <td><code>${session.session_id.substring(0, 12)}...</code></td>
            <td><a href="${session.current_page}" target="_blank">${truncateUrl(session.current_page)}</a></td>
            <td>${formatTimestamp(session.last_activity)}</td>
            <td>${formatDuration(session.duration)}</td>
            <td>
                <button class="btn btn-sm btn-outline-info" onclick="showSessionDetails('${session.session_id}')">
                    상세보기
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// 세션 상세 정보 표시
async function showSessionDetails(sessionId) {
    try {
        const response = await fetch(`/api/sessions/${sessionId}/events/`);
        const events = await response.json();
        
        const modalBody = document.getElementById('session-details');
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>세션 정보</h6>
                    <p><strong>세션 ID:</strong> ${sessionId}</p>
                    <p><strong>이벤트 수:</strong> ${events.length}</p>
                </div>
                <div class="col-md-6">
                    <h6>최근 활동</h6>
                    <div class="timeline">
                        ${events.slice(-5).map(event => `
                            <div class="timeline-item">
                                <small class="text-muted">${formatTimestamp(event.timestamp)}</small><br>
                                <strong>${event.event_type}</strong>: ${event.page_url}
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
        
        new bootstrap.Modal(document.getElementById('sessionModal')).show();
    } catch (error) {
        console.error('Error loading session details:', error);
    }
}

// 유틸리티 함수들
function formatTimestamp(timestamp) {
    return new Date(parseInt(timestamp)).toLocaleString('ko-KR');
}

function formatDuration(duration) {
    const minutes = Math.floor(duration / 60000);
    const seconds = Math.floor((duration % 60000) / 1000);
    return `${minutes}분 ${seconds}초`;
}

function truncateUrl(url) {
    return url.length > 50 ? url.substring(0, 50) + '...' : url;
}

function updateActiveCount(count) {
    document.getElementById('active-count').textContent = count;
}

function refreshSessions() {
    loadActiveSessions();
}

function startAutoRefresh() {
    refreshInterval = setInterval(loadActiveSessions, 10000); // 10초마다 새로고침
}

function showError(message) {
    // 에러 토스트 표시
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-danger border-0';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    document.body.appendChild(toast);
    new bootstrap.Toast(toast).show();
}
</script>
{% endblock %}