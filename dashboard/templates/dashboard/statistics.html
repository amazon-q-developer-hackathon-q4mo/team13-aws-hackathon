{% extends 'base.html' %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>통계 대시보드</h2>
        <div class="row">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">총 세션</h5>
                        <h3 class="text-primary" id="total-sessions">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">총 이벤트</h5>
                        <h3 class="text-success" id="total-events">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">평균 세션 시간</h5>
                        <h3 class="text-info" id="avg-session-time">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">전환율</h5>
                        <h3 class="text-warning" id="conversion-rate">-</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>시간대별 유입 통계</h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary active" onclick="loadHourlyChart(24)">24시간</button>
                    <button type="button" class="btn btn-outline-primary" onclick="loadHourlyChart(168)">7일</button>
                    <button type="button" class="btn btn-outline-primary" onclick="loadHourlyChart(720)">30일</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="hourlyChart" height="100"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>페이지별 조회수</h5>
            </div>
            <div class="card-body">
                <canvas id="pageChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>유입 경로 분석</h5>
            </div>
            <div class="card-body">
                <canvas id="referrerChart" height="50"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
let hourlyChart, pageChart, referrerChart;

document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadStatistics();
});

function initializeCharts() {
    // 시간대별 차트
    const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
    hourlyChart = new Chart(hourlyCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: '세션 수',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // 페이지별 차트
    const pageCtx = document.getElementById('pageChart').getContext('2d');
    pageChart = new Chart(pageCtx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // 유입 경로 차트
    const referrerCtx = document.getElementById('referrerChart').getContext('2d');
    referrerChart = new Chart(referrerCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: '유입 수',
                data: [],
                backgroundColor: 'rgba(54, 162, 235, 0.5)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

async function loadStatistics() {
    try {
        // 기본 통계 로드
        await loadSummaryStats();
        
        // 차트 데이터 로드
        await loadHourlyChart(24);
        await loadPageChart();
        await loadReferrerChart();
        
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

async function loadSummaryStats() {
    try {
        const response = await fetch('/api/statistics/summary/');
        const data = await response.json();
        
        document.getElementById('total-sessions').textContent = data.total_sessions;
        document.getElementById('total-events').textContent = data.total_events;
        document.getElementById('avg-session-time').textContent = data.avg_session_time;
        document.getElementById('conversion-rate').textContent = data.conversion_rate;
    } catch (error) {
        console.error('Error loading summary stats:', error);
        // 에러 시 기본값 표시
        document.getElementById('total-sessions').textContent = '0';
        document.getElementById('total-events').textContent = '0';
        document.getElementById('avg-session-time').textContent = '0분 0초';
        document.getElementById('conversion-rate').textContent = '0.0%';
    }
}

async function loadHourlyChart(hours) {
    try {
        const response = await fetch(`/api/statistics/hourly/?hours=${hours}`);
        const data = await response.json();
        
        hourlyChart.data.labels = data.map(item => item.hour);
        hourlyChart.data.datasets[0].data = data.map(item => item.count);
        hourlyChart.update();
        
        // 버튼 활성화 상태 업데이트
        document.querySelectorAll('.btn-group button').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
    } catch (error) {
        console.error('Error loading hourly chart:', error);
    }
}

async function loadPageChart() {
    try {
        const response = await fetch('/api/statistics/pages/');
        const data = await response.json();
        
        pageChart.data.labels = data.map(item => item.page);
        pageChart.data.datasets[0].data = data.map(item => item.views);
        pageChart.update();
        
    } catch (error) {
        console.error('Error loading page chart:', error);
    }
}

async function loadReferrerChart() {
    try {
        const response = await fetch('/api/statistics/referrers/');
        const data = await response.json();
        
        referrerChart.data.labels = data.labels;
        referrerChart.data.datasets[0].data = data.data;
        referrerChart.update();
    } catch (error) {
        console.error('Error loading referrer chart:', error);
        // 에러 시 기본 데이터 표시
        referrerChart.data.labels = ['No Data'];
        referrerChart.data.datasets[0].data = [0];
        referrerChart.update();
    }
}
</script>
{% endblock %}